<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Vsphere on Cinderblock</title><link>https://cinderblock.github.io/tags/vsphere/</link><description>Recent content in Vsphere on Cinderblock</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Mon, 14 Feb 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://cinderblock.github.io/tags/vsphere/index.xml" rel="self" type="application/rss+xml"/><item><title>Terraform - vSphere Windows Server Deployment</title><link>https://cinderblock.github.io/p/terraform-vsphere-windows-server-deployment/</link><pubDate>Mon, 14 Feb 2022 00:00:00 +0000</pubDate><guid>https://cinderblock.github.io/p/terraform-vsphere-windows-server-deployment/</guid><description>&lt;img src="https://cinderblock.github.io/p/terraform-vsphere-windows-server-deployment/vSphereBanner.png" alt="Featured image of post Terraform - vSphere Windows Server Deployment" /&gt;&lt;h1 id="overview"&gt;Overview&lt;/h1&gt;
&lt;p&gt;The goal of this project is to deploy a ready-to-go windows server environment. This includes a domain controller, a replica domain controller, a DHCP server, and a fileserver. Additionally setting up users, groups, and OUs for the respective users within the domain. &lt;!-- raw HTML omitted --&gt;
To complete this project, 3 steps are taken.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Use Packer to spin up a sys prepped and fully updated windows server 2022 iso for the environemnt&lt;/li&gt;
&lt;li&gt;Use Terraform to deploy 4 virtual machines into a vSphere environment&lt;/li&gt;
&lt;li&gt;Use Ansible to configure these 4 virtual machines as desired&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Check out all of the configuration files on &lt;a class="link" href="https://github.com/Cinderblook/tacklebox/tree/main/Terraform/vSphere/vSphere-WinServ-Deployment" target="_blank" rel="noopener"
&gt;GitHub (vSphere-WinServ-Deployment)&lt;/a&gt; at the repository!&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id="1-packers-role"&gt;1. Packer&amp;rsquo;s Role:&lt;/h2&gt;
&lt;p&gt;Create a Windows Server 2022 .iso that is updated and has VMTools installed by default using &lt;a class="link" href="https://www.packer.io/" target="_blank" rel="noopener"
&gt;Packer&lt;/a&gt;. In this solution, it will be geared to usage with vSphere, a VMware product.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;First: Packer uses &lt;code&gt;autounattend.xml&lt;/code&gt; and &lt;code&gt;sysprep-autounattend.xml&lt;/code&gt; to automate Windows Settings&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It pulls Windows Server 2022 Datacenter Eval Edition (Desktop Experience) from Microsoft&amp;rsquo;s site&lt;/li&gt;
&lt;li&gt;Installs &amp;amp; configure OpenSSH Client &amp;amp; Server for remote connection&lt;/li&gt;
&lt;li&gt;Installs VMware tools from ISO provided from the build ESX server&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Packer Provisioner Steps&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Updating OS via Windows Update&lt;/li&gt;
&lt;li&gt;Doing some OS adjustments
&lt;ul&gt;
&lt;li&gt;Set Windows telemetry settings to minimum&lt;/li&gt;
&lt;li&gt;Show file extentions by default&lt;/li&gt;
&lt;li&gt;Install &lt;a class="link" href="https://chocolatey.org/" target="_blank" rel="noopener"
&gt;Chocolatey&lt;/a&gt; - a Windows package manager
&lt;ul&gt;
&lt;li&gt;Install Microsoft Edge (Chromium)&lt;/li&gt;
&lt;li&gt;Install Win32-OpenSSH-Server&lt;/li&gt;
&lt;li&gt;Install PowerShell Core&lt;/li&gt;
&lt;li&gt;Install 7-Zip&lt;/li&gt;
&lt;li&gt;Install Notepad++&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Enable Powershell-Core (&lt;code&gt;pwsh&lt;/code&gt;) to be the default SSHD shell&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Cleanup tasks&lt;/li&gt;
&lt;li&gt;Remove CDROM drives from VM template (otherwise there would be 2)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="2-terraforms-role"&gt;2. Terraform&amp;rsquo;s Role:&lt;/h2&gt;
&lt;p&gt;Main role: Deploy the Virtual Machines&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Setup the four Windows Servers (Primary Domain Controller, Replica Domain Controller, DHCP, Fileshare)
&lt;ul&gt;
&lt;li&gt;Using the vSphere provider:
&lt;ul&gt;
&lt;li&gt;Assign appropriate resources to each machine&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Once prepared with appropriate values and the networking is in place:
&lt;ul&gt;
&lt;li&gt;Navigate to the Terraform directory and run these commands&lt;/li&gt;
&lt;li&gt;&lt;code&gt;terraform init&lt;/code&gt; Pull proper Terraform providers and modules used&lt;/li&gt;
&lt;li&gt;&lt;code&gt;terraform validate&lt;/code&gt; This will return whether the configuration is valid or not&lt;/li&gt;
&lt;li&gt;&lt;code&gt;terraform apply&lt;/code&gt; &amp;hellip; &lt;code&gt;yes&lt;/code&gt; Actually apply the configuration&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="terraform-variable-files"&gt;Terraform Variable files&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;variables.tf&lt;/em&gt;
&lt;ul&gt;
&lt;li&gt;Declare variables that will be used with the Terraform configuration&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;em&gt;terraform.tfvars&lt;/em&gt;
&lt;ul&gt;
&lt;li&gt;Assign variables that will be used with the Terraform configuration&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="3-ansibles-role"&gt;3. Ansible&amp;rsquo;s Role:&lt;/h2&gt;
&lt;p&gt;Main role: Configure the deployed Virtual Machines.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Setup Windows Server Feature: Domain
&lt;ul&gt;
&lt;li&gt;Primary Domain Controller&lt;/li&gt;
&lt;li&gt;Replica Domain Controller&lt;/li&gt;
&lt;li&gt;Auto-Join the Virutal Machines to the respective Domain created&lt;/li&gt;
&lt;li&gt;Create a few users and groups within Active Directory&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Setup Windows Ssrver Feature: DHCP
&lt;ul&gt;
&lt;li&gt;Setup DHCP Scope&lt;/li&gt;
&lt;li&gt;Authorize it to the Domain.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Setup Windows Server Feature: File Sharing
&lt;ul&gt;
&lt;li&gt;Create two shares
&lt;ul&gt;
&lt;li&gt;An employee share and administrator share. These shares are assigned group permissions.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Common Configurations
&lt;ul&gt;
&lt;li&gt;Enable RDP and allow it through the firewall on all windows servers created&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="ansible-variable-files"&gt;Ansible Variable files&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;inventory.yml&lt;/em&gt;
&lt;ul&gt;
&lt;li&gt;Modify hosts associated with the playbook. Assign the IP addressing.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;em&gt;winlab.yml&lt;/em&gt;
&lt;ul&gt;
&lt;li&gt;Associate &amp;lsquo;roles&amp;rsquo; to the hosts identified in the inventory file.&lt;/li&gt;
&lt;li&gt;These &amp;lsquo;roles&amp;rsquo; are folders within the directory containing a set of code to configure per host&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;em&gt;ansible.cfg&lt;/em&gt;
&lt;ul&gt;
&lt;li&gt;Tells ansible variable information. In this scenario, identifies to use inventory.yml file.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;em&gt;./group_vars/all.yml&lt;/em&gt;
&lt;ul&gt;
&lt;li&gt;Contains specific variable information used within the ./roles/* Ansible code.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="prerequisites"&gt;Prerequisites&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Linux machine with the following
&lt;ul&gt;
&lt;li&gt;Ansible
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;sudo apt update&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sudo apt install software-properties-common&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sudo add-apt-repository --yes --update ppa:ansible/ansible&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sudo apt install ansible&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Terraform
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;sudo apt-get update &amp;amp;&amp;amp; sudo apt-get install -y gnupg software-properties-common curl&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sudo apt-add-repository &amp;quot;deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main&amp;quot;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sudo apt-get update &amp;amp;&amp;amp; sudo apt-get install terraform&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Packer
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sudo apt-add-repository &amp;quot;deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main&amp;quot;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sudo apt-get update &amp;amp;&amp;amp; sudo apt-get install packer&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Git
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;sudo apt-get install git&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;A Code Interprester
&lt;ul&gt;
&lt;li&gt;I recommend &lt;a class="link" href="https://code.visualstudio.com/" target="_blank" rel="noopener"
&gt;Visual-Studio-Code&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;vSphere Lab Environment
&lt;ul&gt;
&lt;li&gt;&lt;a class="link" href="https://www.vmware.com/products/vsphere.html" target="_blank" rel="noopener"
&gt;vSphere&lt;/a&gt; &amp;mdash; &lt;em&gt;Note: This project is using vSphere version 7.0.0&lt;/em&gt;
&lt;!-- raw HTML omitted --&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="packer"&gt;Packer&lt;/h1&gt;
&lt;h2 id="navigate-to-packer-directory"&gt;Navigate to Packer Directory&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;First setup Packer environment
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;packer init -upgrade ws2022.pkr.hcl&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Then apply the Packer configuration to create the Windows Server 2022 Image
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;packer build -timestamp-ui -force -var-file=myvarfile.json ws2022.pkr.hcl&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;This packer execute pulls the newest windows server datacenter 2022 eval .iso from microsoft populates it into the vSphere environment, in the specified datacenter/cluster/host/datastore&lt;/li&gt;
&lt;li&gt;It then runs commands to: Grab DHCP, Updates the image, Enables SSH, Enables RDP, Configures necessary firewall settings, sets passwords/usernames, &amp;amp; installs VMware Tools to base image&lt;/li&gt;
&lt;li&gt;Additionally, it will install &lt;a class="link" href="https://chocolatey.org/" target="_blank" rel="noopener"
&gt;Chocolatey&lt;/a&gt; for packages, notepad++, Edge, &amp;amp; 7-zip
&lt;!-- raw HTML omitted --&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="after-packer-finishes"&gt;After Packer Finishes&lt;/h2&gt;
&lt;h6 id="roughly-an-hour-depending-on-processing-and-internet-speed"&gt;&lt;em&gt;Roughly an hour depending on processing and internet speed&lt;/em&gt;&lt;/h6&gt;
&lt;ul&gt;
&lt;li&gt;Go into your vSphere and turn the resulting VM into a Template
&lt;ul&gt;
&lt;li&gt;Ensure this mimics the variables you have set in the terraform.tfvars file. This will be our next step.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="terraform"&gt;Terraform&lt;/h1&gt;
&lt;h2 id="navigate-to-terraform-directory"&gt;Navigate to Terraform Directory&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Setup Terraform Environemnt
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;terraform init&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Format terraform to ensure it meets criteria required
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;terraform fmt&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Do a terraform plan to detect any potential errors in code and to see potential end result. Read over this
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;terraform plan&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Finally, if all the above appears correct, perform a terraform apply
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;terraform apply&lt;/code&gt; &amp;hellip; &lt;code&gt;yes&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;This may take awhile, once it is done, double check in vSphere all necessary Virtual Machines were created properly &lt;em&gt;(For me this took 20 minutes to fully complete)&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="ansible"&gt;Ansible&lt;/h1&gt;
&lt;h2 id="navigate-to-ansible-directory"&gt;Navigate to Ansible Directory&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Once you have allowed Terraform to finish its configuraiton:
&lt;ul&gt;
&lt;li&gt;Navigate to your Ansible Directory, &lt;code&gt;cd &amp;lt;path-to-Ansible&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Run your ansible playbook &lt;code&gt;ansible-playbook winlab.yml&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;This should run through and detail each change as it plays out&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="references-useduseful-links"&gt;References Used/Useful Links&lt;/h1&gt;
&lt;h3 id="i-sourced-various-code-and-peices-of-information-from-the-following-git-repositories"&gt;I sourced various code and peices of information from the following Git Repositories&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Stefan Zimmermann &lt;a class="link" href="https://gitlab.com/StefanZ8n/packer-ws2022" target="_blank" rel="noopener"
&gt;GitLab&lt;/a&gt; &lt;a class="link" href="https://z8n.eu/2021/11/09/building-a-windows-server-2022-ova-with-packer/" target="_blank" rel="noopener"
&gt;Article&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Dmitry Teslya &lt;a class="link" href="https://github.com/dteslya/win-iac-lab" target="_blank" rel="noopener"
&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="useful-places-for-refernece"&gt;Useful places for refernece&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Tutorials for Terraform, Packer, and others &lt;a class="link" href="https://learn.hashicorp.com/search?query=Packer" target="_blank" rel="noopener"
&gt;Hashicorp-Tutorials&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Ansible &lt;a class="link" href="https://docs.ansible.com/" target="_blank" rel="noopener"
&gt;Documentation&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a class="link" href="https://galaxy.ansible.com/ansible/windows?extIdCarryOver=true&amp;amp;sc_cid=701f2000001OH7YAAW" target="_blank" rel="noopener"
&gt;Windows-Modules&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Terraform &lt;a class="link" href="https://www.terraform.io/docs" target="_blank" rel="noopener"
&gt;Documentation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Packer &lt;a class="link" href="https://www.packer.io/docs" target="_blank" rel="noopener"
&gt;Documentation&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description></item></channel></rss>