<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Terraform Automation in Azure with Kubernetes, Helm, and Cloudflare. Create a ready to go and modify AKS cluster in Azure."><title>Terraform - Azure Kubernetes with Helm Charts and Cloudflare</title><link rel=canonical href=https://cinderblock.github.io/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/><link rel=stylesheet href=/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="Terraform - Azure Kubernetes with Helm Charts and Cloudflare"><meta property="og:description" content="Terraform Automation in Azure with Kubernetes, Helm, and Cloudflare. Create a ready to go and modify AKS cluster in Azure."><meta property="og:url" content="https://cinderblock.github.io/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/"><meta property="og:site_name" content="Cinderblock"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="terraform"><meta property="article:tag" content="cloudflare"><meta property="article:tag" content="automation"><meta property="article:tag" content="azure"><meta property="article:tag" content="K8S"><meta property="article:published_time" content="2022-06-16T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-16T00:00:00+00:00"><meta property="og:image" content="https://cinderblock.github.io/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/AzureK8SHelm.png"><meta name=twitter:title content="Terraform - Azure Kubernetes with Helm Charts and Cloudflare"><meta name=twitter:description content="Terraform Automation in Azure with Kubernetes, Helm, and Cloudflare. Create a ready to go and modify AKS cluster in Azure."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cinderblock.github.io/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/AzureK8SHelm.png"><link rel="shortcut icon" href=images/favicon-32x32.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-SJ16DM3169"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SJ16DM3169",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/Portrait_Austin_hu1b7a0181037ca8e105ddc022cf47b182_5624368_300x0_resize_q75_box.jpg width=300 height=333 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Cinderblock</a></h1><h2 class=site-description>Hey! I'm Austin.</h2></div></header><ol class=social-menu><li><a href=https://www.buymeacoffee.com/cinderblook target=_blank title="Buy Me a Coffee" rel=me><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Buy Me A Coffee</title><path d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723.0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834.0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228.0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185.0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076.0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237.0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704.0 01-4.743.295 37.059 37.059.0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69.0 0011.343.376.483.483.0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484.0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544.0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884.0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38.0.0 1.243.065 1.658.065.447.0 1.786-.065 1.786-.065.783.0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996.0 00-1.322-.238c-.826.0-1.491.284-2.26.613z"/></svg></a></li><li><a href=https://github.com/Cinderblook target=_blank title=GitHub rel=me><svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 .396c-8.839.0-16 7.167-16 16 0 7.073 4.584 13.068 10.937 15.183.803.151 1.093-.344 1.093-.772.0-.38-.009-1.385-.015-2.719-4.453.964-5.391-2.151-5.391-2.151-.729-1.844-1.781-2.339-1.781-2.339-1.448-.989.115-.968.115-.968 1.604.109 2.448 1.645 2.448 1.645 1.427 2.448 3.744 1.74 4.661 1.328.14-1.031.557-1.74 1.011-2.135-3.552-.401-7.287-1.776-7.287-7.907.0-1.751.62-3.177 1.645-4.297-.177-.401-.719-2.031.141-4.235.0.0 1.339-.427 4.4 1.641 1.281-.355 2.641-.532 4-.541 1.36.009 2.719.187 4 .541 3.043-2.068 4.381-1.641 4.381-1.641.859 2.204.317 3.833.161 4.235 1.015 1.12 1.635 2.547 1.635 4.297.0 6.145-3.74 7.5-7.296 7.891.556.479 1.077 1.464 1.077 2.959.0 2.14-.02 3.864-.02 4.385.0.416.28.916 1.104.755 6.4-2.093 10.979-8.093 10.979-15.156.0-8.833-7.161-16-16-16z"/></svg></a></li><li><a href=https://www.instagram.com/austin_barnesz/ target=_blank title=Instagram rel=me><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 551.034 551.034" style="enable-background:new 0 0 551.034 551.034"><g id="XMLID_13_"><linearGradient id="XMLID_2_" gradientUnits="userSpaceOnUse" x1="275.517" y1="4.5714" x2="275.517" y2="549.7202" gradientTransform="matrix(1 0 0 -1 0 554)"><stop offset="0" style="stop-color:#E09B3D"/><stop offset=".3" style="stop-color:#C74C4D"/><stop offset=".6" style="stop-color:#C21975"/><stop offset="1" style="stop-color:#7024C4"/></linearGradient><path id="XMLID_17_" style="fill:url(#XMLID_2_)" d="M386.878.0H164.156C73.64.0.0 73.64.0 164.156v222.722c0 90.516 73.64 164.156 164.156 164.156h222.722c90.516.0 164.156-73.64 164.156-164.156V164.156C551.033 73.64 477.393.0 386.878.0zM495.6 386.878c0 60.045-48.677 108.722-108.722 108.722H164.156c-60.045.0-108.722-48.677-108.722-108.722V164.156c0-60.046 48.677-108.722 108.722-108.722h222.722c60.045.0 108.722 48.676 108.722 108.722V386.878z"/><linearGradient id="XMLID_3_" gradientUnits="userSpaceOnUse" x1="275.517" y1="4.5714" x2="275.517" y2="549.7202" gradientTransform="matrix(1 0 0 -1 0 554)"><stop offset="0" style="stop-color:#E09B3D"/><stop offset=".3" style="stop-color:#C74C4D"/><stop offset=".6" style="stop-color:#C21975"/><stop offset="1" style="stop-color:#7024C4"/></linearGradient><path id="XMLID_81_" style="fill:url(#XMLID_3_)" d="M275.517 133C196.933 133 133 196.933 133 275.516s63.933 142.517 142.517 142.517S418.034 354.1 418.034 275.516 354.101 133 275.517 133zm0 229.6c-48.095.0-87.083-38.988-87.083-87.083s38.989-87.083 87.083-87.083c48.095.0 87.083 38.988 87.083 87.083C362.6 323.611 323.611 362.6 275.517 362.6z"/><linearGradient id="XMLID_4_" gradientUnits="userSpaceOnUse" x1="418.306" y1="4.5714" x2="418.306" y2="549.7202" gradientTransform="matrix(1 0 0 -1 0 554)"><stop offset="0" style="stop-color:#E09B3D"/><stop offset=".3" style="stop-color:#C74C4D"/><stop offset=".6" style="stop-color:#C21975"/><stop offset="1" style="stop-color:#7024C4"/></linearGradient><circle id="XMLID_83_" style="fill:url(#XMLID_4_)" cx="418.306" cy="134.072" r="34.149"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a></li><li><a href=https://www.linkedin.com/in/austin-barnes-03869218a/ target=_blank title=linkedin rel=me><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 382 382" style="enable-background:new 0 0 382 382"><path style="fill:#0077b7" d="M347.445.0H34.555C15.471.0.0 15.471.0 34.555v312.889C0 366.529 15.471 382 34.555 382h312.889C366.529 382 382 366.529 382 347.444V34.555C382 15.471 366.529.0 347.445.0zM118.207 329.844c0 5.554-4.502 10.056-10.056 10.056H65.345c-5.554.0-10.056-4.502-10.056-10.056V150.403c0-5.554 4.502-10.056 10.056-10.056h42.806c5.554.0 10.056 4.502 10.056 10.056V329.844zM86.748 123.432c-22.459.0-40.666-18.207-40.666-40.666S64.289 42.1 86.748 42.1s40.666 18.207 40.666 40.666-18.206 40.666-40.666 40.666zM341.91 330.654c0 5.106-4.14 9.246-9.246 9.246H286.73c-5.106.0-9.246-4.14-9.246-9.246v-84.168c0-12.556 3.683-55.021-32.813-55.021-28.309.0-34.051 29.066-35.204 42.11v97.079c0 5.106-4.139 9.246-9.246 9.246h-44.426c-5.106.0-9.246-4.14-9.246-9.246V149.593c0-5.106 4.14-9.246 9.246-9.246h44.426c5.106.0 9.246 4.14 9.246 9.246v15.655c10.497-15.753 26.097-27.912 59.312-27.912 73.552.0 73.131 68.716 73.131 106.472L341.91 330.654z"/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#prerequisites>Prerequisites</a></li></ol></li><li><a href=#outlined-in-this-post>Outlined in this post</a></li><li><a href=#creating-the-public--private-keys>Creating the Public & Private keys</a></li><li><a href=#setting-up-cloudflare>Setting up Cloudflare</a></li><li><a href=#terraform-process>Terraform Process</a><ol><li><a href=#setting-up-providers-azurerm-kubernetes-helm-kubectl>Setting up Providers; Azurerm, Kubernetes, Helm, Kubectl</a></li><li><a href=#setting-up-infrastructure>Setting up infrastructure</a></li><li><a href=#setting-up-the-kubernetes--helm-attributes>Setting up the Kubernetes & Helm attributes</a></li><li><a href=#assigning-variable-to-variablestfvars>Assigning variable to variables.tfvars</a></li></ol></li><li><a href=#creating-output-to-be-sent-back-after-terraform-finishes-running>Creating output to be sent back after Terraform finishes running</a></li><li><a href=#run-it>Run it</a></li><li><a href=#gain-access-to-kubectl>Gain access to Kubectl</a></li><li><a href=#now-what>Now what?</a></li><li><a href=#useful-resources>Useful Resources</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/><img src=/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/AzureK8SHelm_hu8e324d8d48179918ac16116902203964_216689_800x0_resize_box_3.png srcset="/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/AzureK8SHelm_hu8e324d8d48179918ac16116902203964_216689_800x0_resize_box_3.png 800w, /p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/AzureK8SHelm_hu8e324d8d48179918ac16116902203964_216689_1600x0_resize_box_3.png 1600w" width=800 height=450 loading=lazy alt="Featured image of post Terraform - Azure Kubernetes with Helm Charts and Cloudflare"></a></div><div class=article-details><header class=article-category><a href=/categories/terraform/ style=background-color:#2a9d8f;color:#fff>Terraform</a>
<a href=/categories/azure/ style=background-color:#2a9d8f;color:#fff>Azure</a>
<a href=/categories/kubernetes/ style=background-color:#2a9d8f;color:#fff>Kubernetes</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/>Terraform - Azure Kubernetes with Helm Charts and Cloudflare</a></h2><h3 class=article-subtitle>Terraform Automation in Azure with Kubernetes, Helm, and Cloudflare. Create a ready to go and modify AKS cluster in Azure.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jun 16, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>14 minute read</time></div></footer></div></header><section class=article-content><h1 id=overview>Overview</h1><p>Deplying helm charts in Kubernetes within Azure using the AKS service.</p><ul><li>Build a cluster that is running a few services</li><li>Have cluster automatically scale with load</li><li>Have Kubeconfig file available so it can be managed, changed, altered, destroyed, etc.</li><li>Ensure Kubeconfig file is secure, and is being encrypted with traffic involved in this</li><li>Create a NGINX certificate service utilizing Cloudflare&rsquo;s DNS</li><li>Use Traefik as a loadbalancer, and utilize ingresses for reachable internal services</li></ul><h3 id=prerequisites>Prerequisites</h3><ol><li>Have an Azure account<ul><li><em><a class=link href=https://azure.microsoft.com/en-us/free/students/ target=_blank rel=noopener>if you are a student, sign up for a student account and get some free credits along side it.</a></em></li></ul></li><li>Have a Cloudflare Account & a Domain</li></ol><h2 id=outlined-in-this-post>Outlined in this post</h2><ol><li><a class=link href=#creating-the-public--private-keys>Create a public and private key</a></li><li><a class=link href=#setting-up-cloudflare>Setup Cloudflare</a><ul><li>Obtain a public domain</li><li>Generate a Token for DNS Read and write access</li></ul></li><li><a class=link href=#terraform-process>Setup Terraform files for the deployment</a><ul><li><a class=link href=#setting-up-providers-azurerm-kubernetes-helm>Providers</a></li><li><a class=link href=#setting-up-infrastructure>Infrastructure</a></li><li><a class=link href=#setting-up-the-kubernetes--helm-attributes>Kubernetes, Kubectl, & Helm</a></li><li><a class=link href=#assigning-variable-to-variablestfvars>Assigning Variables</a></li><li><a class=link href=#creating-output-to-be-sent-back-after-terraform-finishes-running>Creating Output</a></li></ul></li><li><a class=link href=#run-it>Run it</a></li><li><a class=link href=#gain-access-to-kubectl>Terraform State and Kubeconfig file</a></li><li><a class=link href=#now-what>Now What?</a></li><li><a class=link href=#useful-resources>Useful Resources</a></li></ol><h2 id=creating-the-public--private-keys>Creating the Public & Private keys</h2><p>First step we&rsquo;ll tackle is the creation of your public and private keys.</p><p>I find the easiest way to do this, is to open up a terminal (Powershell and/or pretty much any linux terminal) and type in a quick few commands. To keep it short and sweet, we will just use <code>ssh-keygen</code></p><p><img src=/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/SSH-keygen-example1.png width=812 height=391 srcset="/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/SSH-keygen-example1_huab67b9959d9bdc9f90f6a0c15103053c_35042_480x0_resize_box_3.png 480w, /p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/SSH-keygen-example1_huab67b9959d9bdc9f90f6a0c15103053c_35042_1024x0_resize_box_3.png 1024w" loading=lazy alt=SSH-Keygen-Example class=gallery-image data-flex-grow=207 data-flex-basis=498px></p><p>Ensure you save this to a locaiton you will remember, it&rsquo;ll be important not to loose either key. This&rsquo;ll allow you SSH access into your Kubernetes cluster.</p><p>Copy your public key you genereated into the same folder as your .tf files will be located.</p><h2 id=setting-up-cloudflare>Setting up Cloudflare</h2><p>Second step on our list, is to setup Cloudflare.</p><p>Cloudflare is important here, since it will be handing out certificates to services running within the Kubernetes cluster. Luckily, <a class=link href=https://dash.cloudflare.com/login target=_blank rel=noopener>signing up for Cloudflare is free</a>, and I&rsquo;ll go over how to obtain a Token for API access.</p><p>Once you have created your account, and have obtained a public domain, you should see a page similar to the following;</p><p><img src=/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/Cloudflare-example1.png width=1400 height=529 srcset="/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/Cloudflare-example1_hu1efc582c417561888b438211de761828_45932_480x0_resize_box_3.png 480w, /p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/Cloudflare-example1_hu1efc582c417561888b438211de761828_45932_1024x0_resize_box_3.png 1024w" loading=lazy alt="Cloudflare Overview Page" class=gallery-image data-flex-grow=264 data-flex-basis=635px></p><p>Scroll down on the overview tab, and on the right hand side, there should be a &lsquo;Get your API token&rsquo; link. On the following page, click &lsquo;Create token&rsquo;</p><p><img src=/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/Cloudflare-example2.png width=1578 height=292 srcset="/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/Cloudflare-example2_huc0c3a23a7e4deb4ac5e8eb7961092016_24036_480x0_resize_box_3.png 480w, /p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/Cloudflare-example2_huc0c3a23a7e4deb4ac5e8eb7961092016_24036_1024x0_resize_box_3.png 1024w" loading=lazy alt="Cloudflare Token Creation" class=gallery-image data-flex-grow=540 data-flex-basis=1296px></p><p>Scroll down to the bottom, and select &lsquo;Create Custom Token`. On the following page, ensure you give your token a memorable name, assign it permissions to read and edit DNS zone settings, and limit it to your respective Zone resources (Domain). Set the TTL to the duration of your project.</p><p><img src=/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/Cloudflare-example3.png width=1579 height=907 srcset="/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/Cloudflare-example3_hueb4bc414788dc54b7c465eaff5d6c1fa_71706_480x0_resize_box_3.png 480w, /p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/Cloudflare-example3_hueb4bc414788dc54b7c465eaff5d6c1fa_71706_1024x0_resize_box_3.png 1024w" loading=lazy alt="Cloudflare Token Policy" class=gallery-image data-flex-grow=174 data-flex-basis=417px></p><p>Continue to summary, and collect the API token key, store it discretely. This Token will be used in Terraform, within the .tfvars file later for authentication with the Cloudflare API.</p><h2 id=terraform-process>Terraform Process</h2><p>I prefer to seperate my Terraform files for readability, feel free to see all the code at a glance on the <a class=link href>Github Repo</a>. I&rsquo;ll do a breakdown here in this section.</p><h3 id=setting-up-providers-azurerm-kubernetes-helm-kubectl>Setting up Providers; Azurerm, Kubernetes, Helm, Kubectl</h3><p>In this situation, I am authenticating to Azure using their AzureCLI. Refer to <a class=link href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli target=_blank rel=noopener>Microsoft&rsquo;s official documentation for Azure CLI</a> setup. Kubernetes, Kubectl, and Helm don&rsquo;t require and specific authentication. The API Token generated earlier to authenticate with Cloudflare. This&rsquo;ll be defined in the .tfvars file.</p><p>Take the following code, and put it into a file called providers.tf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>required_version</span> = <span class=s2>&#34;&gt;= 0.14.8&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>required_providers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>azurerm</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>source</span>  = <span class=s2>&#34;hashicorp/azurerm&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>version</span> = <span class=s2>&#34;~&gt; 3.0.2&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=na>helm</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>source</span> = <span class=s2>&#34;hashicorp/helm&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>version</span> = <span class=s2>&#34;~&gt;2.5.1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=na>kubernetes</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>source</span> = <span class=s2>&#34;hashicorp/kubernetes&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>version</span> = <span class=s2>&#34;~&gt; 2.8.0&#34;</span>     
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=na>kubectl</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>source</span> = <span class=s2>&#34;gavinbunney/kubectl&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>version</span> = <span class=s2>&#34;~&gt; 1.14.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=na>cloudflare</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>source</span> = <span class=s2>&#34;cloudflare/cloudflare&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>version</span> = <span class=s2>&#34;~&gt; 3.16.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;azurerm&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>features</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;kubernetes&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>host</span>        = <span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>host</span>
</span></span><span class=line><span class=cl>  <span class=na>client_certificate</span>     =<span class=nb> base64decode</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>client_certificate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=na>client_key</span>             =<span class=nb> base64decode</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>client_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=na>cluster_ca_certificate</span> =<span class=nb> base64decode</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>cluster_ca_certificate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;helm&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>kubernetes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>host</span>        = <span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>host</span>
</span></span><span class=line><span class=cl>    <span class=na>client_certificate</span>     =<span class=nb> base64decode</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>client_certificate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=na>client_key</span>             =<span class=nb> base64decode</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>client_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=na>cluster_ca_certificate</span> =<span class=nb> base64decode</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>cluster_ca_certificate</span><span class=p>)</span>    
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;kubectl&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>host</span>        = <span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>host</span>
</span></span><span class=line><span class=cl>    <span class=na>client_certificate</span>     =<span class=nb> base64decode</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>client_certificate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=na>client_key</span>             =<span class=nb> base64decode</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>client_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=na>cluster_ca_certificate</span> =<span class=nb> base64decode</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>credneitals</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>cluster_ca_certificate</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=na>load_config_file</span> = <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;cloudflare&#34;</span> <span class=p>{</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Comment out key &amp; email if using token
</span></span></span><span class=line><span class=cl><span class=c1>    #email = var.cloudflare_email
</span></span></span><span class=line><span class=cl><span class=c1>    #api_key = var.cloudflare_api_key
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=na>api_token</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>cloudflare_token</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=setting-up-infrastructure>Setting up infrastructure</h3><p>I sepereated the &lsquo;structure&rsquo; into a few seperate files. One for networking aspects in Azure; <code>networking.tf</code>. Another for the k8s cluster itself (AKS); <code>cluster.tf</code>.</p><p>Within the networking file, it will setup firewall rules for the virtual private network, create the network itself, and create a load balancer.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=c1># Resource Group for Terraform deployment
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_resource_group&#34;</span> <span class=s2>&#34;cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>     = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>prefix</span><span class=si>}</span><span class=s2>-cluster&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>location</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>region</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Networking Setup for Cluster
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_virtual_network&#34;</span> <span class=s2>&#34;cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>                = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>prefix</span><span class=si>}</span><span class=s2>-network&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>location</span>            = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=na>resource_group_name</span> = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=na>address_space</span>       = <span class=p>[</span><span class=s2>&#34;10.1.0.0/16&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Assign subnet for Cluster
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_subnet&#34;</span> <span class=s2>&#34;cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>                 = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>prefix</span><span class=si>}</span><span class=s2>-subnet&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>virtual_network_name</span> = <span class=nx>azurerm_virtual_network</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=na>resource_group_name</span>  = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=na>address_prefixes</span>     = <span class=p>[</span><span class=s2>&#34;10.1.0.0/24&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Firewall settings for cluster
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_security_group&#34;</span> <span class=s2>&#34;cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>                = <span class=s2>&#34;Allow-RDP-SSH-KCTL&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>location</span>            = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=na>resource_group_name</span> = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>security_rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span>                       = <span class=s2>&#34;HTTP&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>priority</span>                   = <span class=m>101</span>
</span></span><span class=line><span class=cl>    <span class=na>direction</span>                  = <span class=s2>&#34;Inbound&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>access</span>                     = <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>protocol</span>                   = <span class=s2>&#34;Tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>source_port_range</span>          = <span class=s2>&#34;80&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>destination_port_range</span>     = <span class=s2>&#34;80&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>source_address_prefix</span>      = <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>destination_address_prefix</span> = <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>security_rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span>                       = <span class=s2>&#34;HTTPS&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>priority</span>                   = <span class=m>102</span>
</span></span><span class=line><span class=cl>    <span class=na>direction</span>                  = <span class=s2>&#34;Inbound&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>access</span>                     = <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>protocol</span>                   = <span class=s2>&#34;Tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>source_port_range</span>          = <span class=s2>&#34;443&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>destination_port_range</span>     = <span class=s2>&#34;443&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>source_address_prefix</span>      = <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>destination_address_prefix</span> = <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>security_rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span>                       = <span class=s2>&#34;k8s-api&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>priority</span>                   = <span class=m>103</span>
</span></span><span class=line><span class=cl>    <span class=na>direction</span>                  = <span class=s2>&#34;Inbound&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>access</span>                     = <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>protocol</span>                   = <span class=s2>&#34;Tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>source_port_range</span>          = <span class=s2>&#34;6443&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>destination_port_range</span>     = <span class=s2>&#34;6443&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>source_address_prefix</span>      = <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>destination_address_prefix</span> = <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Force Terraform to wait
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;time_sleep&#34;</span> <span class=s2>&#34;wait_for_kubernetes&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>create_duration</span> = <span class=s2>&#34;20s&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Create public IP for load balancer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_public_ip&#34;</span> <span class=s2>&#34;cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>                = <span class=s2>&#34;K8S-PublicIPAddress&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>resource_group_name</span> = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=na>location</span>            = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=na>allocation_method</span>   = <span class=s2>&#34;Static&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Assign loadbalancer to a Data variable, for user later
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_lb&#34;</span> <span class=s2>&#34;traefik_lb&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span><span class=nx>helm_release</span><span class=p>.</span><span class=nx>traefik</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span> = <span class=s2>&#34;k8s-traefik-lb&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>resource_group_name</span> = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>    <span class=na>location</span>            = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>    <span class=nx>frontend_ip_configuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>name</span>                 = <span class=nx>azurerm_public_ip</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>      <span class=na>public_ip_address_id</span> = <span class=nx>azurerm_public_ip</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Within the cluster file, we&rsquo;ll define the virtual machine AKS structure being created.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=c1># Create Kubernetes Cluster
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_kubernetes_cluster&#34;</span> <span class=s2>&#34;cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>                = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>prefix</span><span class=si>}</span><span class=s2>-aks&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>location</span>            = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=na>resource_group_name</span> = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=na>dns_prefix</span>          = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>prefix</span><span class=si>}</span><span class=s2>-aks&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>linux_profile</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>admin_username</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>linux_user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>ssh_key</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=na>key_data</span> = <span class=nb>file</span><span class=p>(</span><span class=nb>var</span><span class=p>.</span><span class=nx>ssh_public_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>default_node_pool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span>                = <span class=s2>&#34;agentpool&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>node_count</span>          = <span class=nb>var</span><span class=p>.</span><span class=nx>cluster_nodes_count</span>
</span></span><span class=line><span class=cl>    <span class=na>vm_size</span>             = <span class=s2>&#34;Standard_B2s&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>type</span>                = <span class=s2>&#34;VirtualMachineScaleSets&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>    #availability_zones  = [&#34;1&#34;, &#34;2&#34;]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=na>enable_auto_scaling</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=na>min_count</span>           = <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=na>max_count</span>           = <span class=m>3</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>    # Required for advanced networking
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=na>vnet_subnet_id</span> = <span class=nx>azurerm_subnet</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>    ### Uncomment this and add id/secret for management 
</span></span></span><span class=line><span class=cl><span class=c1>    #service_principal {
</span></span></span><span class=line><span class=cl><span class=c1>    #    client_id     = var.aks_service_principal_app_id
</span></span></span><span class=line><span class=cl><span class=c1>    #    client_secret = var.aks_service_principal_client_secret
</span></span></span><span class=line><span class=cl><span class=c1>    #}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>identity</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>type</span> = <span class=s2>&#34;SystemAssigned&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>network_profile</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>network_plugin</span>    = <span class=s2>&#34;kubenet&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>load_balancer_sku</span> = <span class=s2>&#34;standard&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  #addon_profile {
</span></span></span><span class=line><span class=cl><span class=c1>  #    oms_agent {
</span></span></span><span class=line><span class=cl><span class=c1>  #    enabled                    = true
</span></span></span><span class=line><span class=cl><span class=c1>  #    log_analytics_workspace_id = azurerm_log_analytics_workspace.test.id
</span></span></span><span class=line><span class=cl><span class=c1>  #    }
</span></span></span><span class=line><span class=cl><span class=c1>  #}
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=na>tags</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>Environment</span> = <span class=s2>&#34;Development&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Assign credentials to data, used for helm, kubernetes, and kubectl providers.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>data</span> <span class=s2>&#34;azurerm_kubernetes_cluster&#34;</span> <span class=s2>&#34;credneitals&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>                = <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=na>resource_group_name</span> = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=na>depends_on</span>          = <span class=p>[</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Pull kubeconfig to your local machine
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;local_file&#34;</span> <span class=s2>&#34;kubeconfig&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>depends_on</span>   = <span class=p>[</span><span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=na>filename</span>     = <span class=s2>&#34;./kubeconfig&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>content</span>      = <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>kube_config_raw</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=setting-up-the-kubernetes--helm-attributes>Setting up the Kubernetes & Helm attributes</h3><p>First file we&rsquo;ll make is a <code>nginx.tf</code> file. Within it we will define the manifest attributes of the deployment, and setup an ingress for accessing the service</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=c1># nginx deployment
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;kubernetes_namespace&#34;</span> <span class=s2>&#34;nginx&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>name</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Create the YAML configuration for nginx within the kubernetes provider
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;kubernetes_deployment&#34;</span> <span class=s2>&#34;nginx&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=nx>kubernetes_namespace</span><span class=p>.</span><span class=nx>nginx</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>name</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>namespace</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>labels</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=na>app</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>spec</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>replicas</span> = <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=nx>selector</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=na>match_labels</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=na>app</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>template</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=na>labels</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=na>app</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>spec</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>container</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=na>image</span> = <span class=s2>&#34;nginx:latest&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>name</span>  = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=nx>port</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=na>container_port</span> = <span class=m>80</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Set namespace and port assignments for nginx access
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;kubernetes_service&#34;</span> <span class=s2>&#34;nginx&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span><span class=nx>kubernetes_namespace</span><span class=p>.</span><span class=nx>nginx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>name</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>namespace</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>spec</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>selector</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=na>app</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>port</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=na>port</span> = <span class=m>80</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>type</span> = <span class=s2>&#34;ClusterIP&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Create ingress for NGINX - Allow outside communication to it 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;kubernetes_ingress_v1&#34;</span> <span class=s2>&#34;nginx&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span><span class=nx>kubernetes_namespace</span><span class=p>.</span><span class=nx>nginx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>name</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>namespace</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>spec</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=na>host</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>cloudflare_domainname</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>http</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nx>path</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=na>path</span> = <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=nx>backend</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>service</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=na>name</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>                            <span class=nx>port</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=na>number</span> = <span class=m>80</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>tls</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=na>secret_name</span> = <span class=s2>&#34;nginx&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>hosts</span> = <span class=p>[</span><span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>cloudflare_domainname</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Assign deployments/nginx-cert.yml file to a data value 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>data</span> <span class=s2>&#34;kubectl_path_documents&#34;</span> <span class=s2>&#34;nginx&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>pattern</span> = <span class=s2>&#34;./deployments/nginx-cert.yml&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>vars</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cloudflare</span><span class=o>-</span><span class=na>domainname</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>cloudflare_domainname</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Set nginx config, pulls yaml information from deployments/nginx-cert.yml 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;kubectl_manifest&#34;</span> <span class=s2>&#34;nginx-certificate&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>for_each</span>     = <span class=nb>toset</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>kubectl_path_documents</span><span class=p>.</span><span class=nx>nginx</span><span class=p>.</span><span class=nx>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=na>yaml_body</span>    = <span class=nb>each</span><span class=p>.</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span><span class=nx>kubernetes_namespace</span><span class=p>.</span><span class=nx>nginx</span><span class=p>,</span> <span class=nx>time_sleep</span><span class=p>.</span><span class=nx>wait_for_clusterissuer</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The second step setup, is to define <code>cloudflare.tf</code> file for setting up Cloudflare and the certmanager aspect. This will be done by using Kubectl manifest, namespace creation, and a Helm chart deployment.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=c1># Assign namespace for certmanager
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;kubernetes_namespace&#34;</span> <span class=s2>&#34;certmanager&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>name</span> = <span class=s2>&#34;certmanager&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Intiates Cloudflare secret for Kubernetes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;kubernetes_secret&#34;</span> <span class=s2>&#34;cloudflare_api_key_secret&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=nx>kubernetes_namespace</span><span class=p>.</span><span class=nx>certmanager</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>name</span> = <span class=s2>&#34;cloudflare-api-key-secret&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>namespace</span> = <span class=s2>&#34;certmanager&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>    data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>api</span><span class=o>-</span><span class=na>key</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>cloudflare_api_key</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=na>type</span> = <span class=s2>&#34;Opaque&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Assign deployments/cloudflare.yml file to a data value 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>data</span> <span class=s2>&#34;kubectl_path_documents&#34;</span> <span class=s2>&#34;cloudflare&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>pattern</span> = <span class=s2>&#34;./deployments/cloudflare.yml&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>vars</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cloudflare</span><span class=o>-</span><span class=na>email</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>cloudflare_email</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Create a ClusterIssuer, pulls yaml information from deployments/cloudflare.yml
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;kubectl_manifest&#34;</span> <span class=s2>&#34;cloudflare_prod&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>for_each</span>     = <span class=nb>toset</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>kubectl_path_documents</span><span class=p>.</span><span class=nx>cloudflare</span><span class=p>.</span><span class=nx>documents</span><span class=p>)</span>       
</span></span><span class=line><span class=cl>    <span class=na>yaml_body</span>    = <span class=nb>each</span><span class=p>.</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span><span class=nx>time_sleep</span><span class=p>.</span><span class=nx>wait_for_certmanager</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;cloudflare_record&#34;</span> <span class=s2>&#34;cluster&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>zone_id</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>cloudflare_zonid</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>cloudflare_domainname</span>
</span></span><span class=line><span class=cl>    <span class=na>value</span> =  <span class=nx>azurerm_public_ip</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>ip_address</span>
</span></span><span class=line><span class=cl>    <span class=na>type</span> = <span class=s2>&#34;A&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>proxied</span> = <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span><span class=nx>azurerm_lb</span><span class=p>.</span><span class=nx>traefik_lb</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Force Terraform to wait
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;time_sleep&#34;</span> <span class=s2>&#34;wait_for_clusterissuer&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=nx>kubectl_manifest</span><span class=p>.</span><span class=nx>cloudflare_prod</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>create_duration</span> = <span class=s2>&#34;30s&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Use helm to deploy certmanager in cluster
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;helm_release&#34;</span> <span class=s2>&#34;certmanager&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=nx>kubernetes_namespace</span><span class=p>.</span><span class=nx>certmanager</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span> = <span class=s2>&#34;certmanager&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>namespace</span> = <span class=s2>&#34;certmanager&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>repository</span> = <span class=s2>&#34;https://charts.jetstack.io&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>chart</span> = <span class=s2>&#34;cert-manager&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>set</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>name</span>  = <span class=s2>&#34;installCRDs&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>value</span> = <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>    
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Force Terraform to wait
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;time_sleep&#34;</span> <span class=s2>&#34;wait_for_certmanager&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>depends_on</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=nx>helm_release</span><span class=p>.</span><span class=nx>certmanager</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>create_duration</span> = <span class=s2>&#34;10s&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Third we will create the <code>traefik.tf</code> file. This will allow use to utilize loadbalacning and ingress.Traefik will be implemented using Helm.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=c1># Traefik Deployment
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;kubernetes_namespace&#34;</span> <span class=s2>&#34;traefik&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>name</span> = <span class=s2>&#34;traefik&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;helm_release&#34;</span> <span class=s2>&#34;traefik&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=na>depends_on</span> = <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubernetes_namespace</span><span class=p>.</span><span class=nx>traefik</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>name</span> = <span class=s2>&#34;traefik&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>namespace</span> = <span class=s2>&#34;traefik&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>repository</span> = <span class=s2>&#34;https://helm.traefik.io/traefik&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>chart</span>      = <span class=s2>&#34;traefik&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>set</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span>  = <span class=s2>&#34;ingressClass.enabled&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>value</span> = <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>set</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span>  = <span class=s2>&#34;ingressClass.isDefaultClass&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>value</span> = <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>set</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>name</span> = <span class=s2>&#34;ports.web.redirectTo&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>value</span> = <span class=s2>&#34;websecure&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>set</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>name</span> = <span class=s2>&#34;ports.websecure.tls.enabled&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>value</span> = <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>data</span> <span class=s2>&#34;kubernetes_service&#34;</span> <span class=s2>&#34;traefik&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=na>name</span> = <span class=nx>helm_release</span><span class=p>.</span><span class=nx>traefik</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>   <span class=na>namespace</span> = <span class=nx>helm_release</span><span class=p>.</span><span class=nx>traefik</span><span class=p>.</span><span class=nx>namespace</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=assigning-variable-to-variablestfvars>Assigning variable to variables.tfvars</h3><p>First create and define variables within a <code>variables.tf</code> file.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;cluster_name&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>default</span> = <span class=s2>&#34;terraformclust&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;cluster_nodes_count&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>default</span> = <span class=s2>&#34;2&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;region&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>default</span> = <span class=s2>&#34;East US 2&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;prefix&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>default</span> = <span class=s2>&#34;test&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;ssh_public_key&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>default</span> = <span class=s2>&#34;./id_rsa.pub&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;cloudflare_api_key&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;cloudflare_email&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;cloudflare_api_key_secret&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;cloudflare_prod_account_key&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;cloudflare_zonid&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;cloudflare_domainname&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;cloudflare_token&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;linux_user&#34;</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>Assign correct Cloudflare information into the <code>tfvariables.auto.tfvars</code> file. Follow along with the <code>tfvariables.auto.tfvars.example</code> file.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=na>cloudflare_api_key</span> = <span class=s2>&#34;api key here&#34;</span><span class=c1>                                 # This should have DNS read/write permissions in Cloudflare 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=na>cloudflare_email</span>   = <span class=s2>&#34;email associated to account&#34;</span><span class=c1>                  # Used to login with
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=na>cloudflare_api_key_secret</span> = <span class=s2>&#34;Cloudflare key secret&#34;</span><span class=c1>                 # Used for cloudflare.yml file
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=na>cloudflare_prod_account_key</span> = <span class=s2>&#34;Cloudflare production account key&#34;</span><span class=c1>   # Used for cloudflare.yml file
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=na>cloudflare_zonid</span> = <span class=s2>&#34;Zone ID for cloudflare account&#34;</span><span class=c1>                 # Used for Cloudflare resource
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=na>cloudflare_domainname</span> = <span class=s2>&#34;domain name&#34;</span><span class=c1>                               # Used for Cloudflare resource
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=na>cloudflare_token</span> = <span class=s2>&#34;cloudflare token&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>linux_user</span> = <span class=s2>&#34;username&#34;</span><span class=c1>                                             #Admin access to cluster master(s)
</span></span></span></code></pre></td></tr></table></div></div><p>As for the SSH key, ensure you have a .pub file that you are pulling data from, or directly put SSH key into into variable file.</p><h2 id=creating-output-to-be-sent-back-after-terraform-finishes-running>Creating output to be sent back after Terraform finishes running</h2><p>An important step, is creating necessary output data to result from running the terraform apply. In this scenario, it is critical to have data from the cluster such as certificate information, the kubeconfig, and cluster credentials. Luckily, since these are obviously sensitive data, we can force a <code>sensitive = true</code> attribute to them, and just have the State file hold onto that information. This&rsquo;ll allow us to pull the Kube config to control the K8S cluster to our machine.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=c1># It is necessary to identify these variables for usage later when updating the state file or using kubectl commands
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>output</span> <span class=s2>&#34;client_key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>value</span> = <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>client_key</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;client_certificate&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>value</span> = <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>client_certificate</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;cluster_ca_certificate&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>value</span> = <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>cluster_ca_certificate</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;cluster_username&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>value</span> = <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>username</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;cluster_password&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>value</span> = <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>password</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;kube_config&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>value</span> = <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>kube_config_raw</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;host&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>value</span> = <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>kube_config</span><span class=p>.</span><span class=m>0</span><span class=p>.</span><span class=nx>host</span>
</span></span><span class=line><span class=cl>  <span class=na>sensitive</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Critical to get kubectl file connected out to Azure for local environment
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>output</span> <span class=s2>&#34;cluster_name&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>value</span> = <span class=nx>azurerm_kubernetes_cluster</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;resource_group_name&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>value</span> = <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>#Public IP of Cluster
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>output</span> <span class=s2>&#34;cluster_public_ip&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>value</span> = <span class=nx>azurerm_public_ip</span><span class=p>.</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>ip_address</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=run-it>Run it</h2><p>Once everything is setup and ready to roll, navigate into the directory containing all terraform files.</p><ol><li>Run a <code>terraform init</code></li><li>Then <code>terraform validate</code></li><li>If everything checks out, run <code>terraform apply</code>, and in roughly 5 minutes you should have a running AKS cluster in Azure!</li></ol><h2 id=gain-access-to-kubectl>Gain access to Kubectl</h2><p>In order to gain access from your local machine, we will use the azure CLI. If you followed the tutorial, you&rsquo;ll already be logged in, <code>az login</code>. Use the following command to set your environment varialbe for kubectl to control kubernetes cluster in Azure.
<code>az aks get-credentials --resource-group $(terraform output -raw resource_group_name) --name $(terraform output -raw cluster_name)</code></p><p>Once ran, you can verify it is connected and working with <code>kubectl get nodes</code> , <code>kubectl get namespace</code></p><h2 id=now-what>Now what?</h2><p>Congragulations! The hard part of getting started, is now over. You now have a ready to spin up AKS cluster in Azure prebuilt with a loadbalancer and certificate automation. From here, the possibilites are limitless.</p><h2 id=useful-resources>Useful Resources</h2><ul><li><a class=link href=https://learnk8s.io/terraform-aks target=_blank rel=noopener>Kubernetes Overview</a></li><li><a class=link href=https://registry.terraform.io/providers/hashicorp/kubernetes/latest target=_blank rel=noopener>Terraform Kubernetes</a></li><li><a class=link href=https://registry.terraform.io/providers/hashicorp/azurerm/latest target=_blank rel=noopener>Terraform Azurerm</a></li><li><a class=link href=https://registry.terraform.io/providers/hashicorp/helm/2.5.0 target=_blank rel=noopener>Terraform Helm</a></li></ul><p><a class=link href=https://github.com/xcad2k/boilerplates/tree/main/terraform/templates/kubernetes-automation-example target=_blank rel=noopener>https://github.com/xcad2k/boilerplates/tree/main/terraform/templates/kubernetes-automation-example</a>
<a class=link href="https://www.youtube.com/watch?v=kFt0OGd_LhI&amp;t=870s" target=_blank rel=noopener>https://www.youtube.com/watch?v=kFt0OGd_LhI&t=870s</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/terraform/>terraform</a>
<a href=/tags/cloudflare/>cloudflare</a>
<a href=/tags/automation/>automation</a>
<a href=/tags/azure/>azure</a>
<a href=/tags/k8s/>K8S</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/terraform-azure-kubernetes-deployment/><div class=article-image><img src=/p/terraform-azure-kubernetes-deployment/_hua55605408eff8611cfa14e7c2dd7cd7c_981428_d62f9281aa26219a058427eb28075b11.png width=250 height=150 loading=lazy alt="Featured image of post Terraform - Azure Kubernetes Deployment" data-hash="md5-rk/CKSfAqJI8Q4idPeARwQ=="></div><div class=article-details><h2 class=article-title>Terraform - Azure Kubernetes Deployment</h2></div></a></article><article class=has-image><a href=/p/terrifying-or-converting-azure-resources-into-terraform-code/><div class=article-image><img src=/p/terrifying-or-converting-azure-resources-into-terraform-code/AzureTerrify.46c36dd56028f46810e468b1f1c88936_hud2d7185e8cbfb57e1a609141917a3c4f_215916_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 'Terrifying' or Converting Azure Resources into Terraform Code" data-hash="md5-RsNt1WAo9GgQ5Gix8ciJNg=="></div><div class=article-details><h2 class=article-title>'Terrifying' or Converting Azure Resources into Terraform Code</h2></div></a></article><article class=has-image><a href=/p/terraform-azure-server-deploy/><div class=article-image><img src=/p/terraform-azure-server-deploy/Azure&amp;Terraform.44c45b8d936f6d23b7ff6c8549318fcc_huba542f586351a1d31609965a810d8cb5_154659_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Terraform - Azure Server Deploy" data-hash="md5-RMRbjZNvbSO3/2yFSTGPzA=="></div><div class=article-details><h2 class=article-title>Terraform - Azure Server Deploy</h2></div></a></article><article class=has-image><a href=/p/openvpn-site-to-site-homelab/><div class=article-image><img src=/p/openvpn-site-to-site-homelab/openvpn_sitetosite.551243fa336fd75392dc73ccaa7c8abd_huefec28f890f3a52601c6d36e2c7b3a5e_555051_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post OpenVPN Site-to-Site - HomeLab" data-hash="md5-VRJD+jNv11OS3HPMqnyKvQ=="></div><div class=article-details><h2 class=article-title>OpenVPN Site-to-Site - HomeLab</h2></div></a></article><article class=has-image><a href=/p/terraform-spotify-automation/><div class=article-image><img src=/p/terraform-spotify-automation/SpotifyAutomation.d605f4bea8b3c56d1949fc40c6a93237_hub0bd49f7622d39e4013fd6e22c6a0b5f_625830_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Terraform - Spotify Automation" data-hash="md5-1gX0vqizxW0ZSfxAxqkyNw=="></div><div class=article-details><h2 class=article-title>Terraform - Spotify Automation</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//cinderblock.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2021 -
2023 Cinderblock</section><section class=powerby>Enthusiastic guy who enjoys the outdoors, flying drones, homelabbing, and of course, all things tech!<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>