<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Terraform Automation in Azure with Windows Server. Creating an entire domain with DHCP, Filesharing, Active Dircetory, and more.'><title>Terraform - Azure Server Deploy</title><link rel=canonical href=https://cinderblock.github.io/p/terraform-azure-server-deploy/><link rel=stylesheet href=/scss/style.min.22ad1c74b5bb435181c77741d99f034b2c36f7272eff9d0d1aa16d32e7e84673.css><meta property='og:title' content='Terraform - Azure Server Deploy'><meta property='og:description' content='Terraform Automation in Azure with Windows Server. Creating an entire domain with DHCP, Filesharing, Active Dircetory, and more.'><meta property='og:url' content='https://cinderblock.github.io/p/terraform-azure-server-deploy/'><meta property='og:site_name' content='Cinderblock'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='terraform'><meta property='article:tag' content='ansible'><meta property='article:tag' content='automation'><meta property='article:tag' content='azure'><meta property='article:tag' content='windows-server'><meta property='article:published_time' content='2022-02-28T00:00:00+00:00'><meta property='article:modified_time' content='2022-02-28T00:00:00+00:00'><meta property='og:image' content='https://cinderblock.github.io/p/terraform-azure-server-deploy/Azure&amp;Terraform.png'><meta name=twitter:title content="Terraform - Azure Server Deploy"><meta name=twitter:description content="Terraform Automation in Azure with Windows Server. Creating an entire domain with DHCP, Filesharing, Active Dircetory, and more."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://cinderblock.github.io/p/terraform-azure-server-deploy/Azure&amp;Terraform.png'><link rel="shortcut icon" href=images/favicon-32x32.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/Portrait_Austin_hu_1f04edd8032896ec.jpg width=300 height=333 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Cinderblock</a></h1><h2 class=site-description>Hey! I'm Austin.</h2></div></header><ol class=social-menu><li><a href=https://www.buymeacoffee.com/cinderblook target=_blank title="Buy Me a Coffee" rel=me><svg role="img" viewBox="0 0 24 24"><title>Buy Me A Coffee</title><path d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723.0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834.0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228.0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185.0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076.0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237.0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704.0 01-4.743.295 37.059 37.059.0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69.0 0011.343.376.483.483.0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484.0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544.0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884.0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38.0.0 1.243.065 1.658.065.447.0 1.786-.065 1.786-.065.783.0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996.0 00-1.322-.238c-.826.0-1.491.284-2.26.613z"/></svg></a></li><li><a href=https://github.com/Cinderblook target=_blank title=GitHub rel=me><svg width="32" height="32" viewBox="0 0 32 32"><path d="M16 .396c-8.839.0-16 7.167-16 16 0 7.073 4.584 13.068 10.937 15.183.803.151 1.093-.344 1.093-.772.0-.38-.009-1.385-.015-2.719-4.453.964-5.391-2.151-5.391-2.151-.729-1.844-1.781-2.339-1.781-2.339-1.448-.989.115-.968.115-.968 1.604.109 2.448 1.645 2.448 1.645 1.427 2.448 3.744 1.74 4.661 1.328.14-1.031.557-1.74 1.011-2.135-3.552-.401-7.287-1.776-7.287-7.907.0-1.751.62-3.177 1.645-4.297-.177-.401-.719-2.031.141-4.235.0.0 1.339-.427 4.4 1.641 1.281-.355 2.641-.532 4-.541 1.36.009 2.719.187 4 .541 3.043-2.068 4.381-1.641 4.381-1.641.859 2.204.317 3.833.161 4.235 1.015 1.12 1.635 2.547 1.635 4.297.0 6.145-3.74 7.5-7.296 7.891.556.479 1.077 1.464 1.077 2.959.0 2.14-.02 3.864-.02 4.385.0.416.28.916 1.104.755 6.4-2.093 10.979-8.093 10.979-15.156.0-8.833-7.161-16-16-16z"/></svg></a></li><li><a href=https://www.instagram.com/austin_barnesz/ target=_blank title=Instagram rel=me><svg id="Layer_1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 551.034 551.034" style="enable-background:new 0 0 551.034 551.034"><g id="XMLID_13_"><linearGradient id="XMLID_2_" gradientUnits="userSpaceOnUse" x1="275.517" y1="4.5714" x2="275.517" y2="549.7202" gradientTransform="matrix(1 0 0 -1 0 554)"><stop offset="0" style="stop-color:#E09B3D"/><stop offset=".3" style="stop-color:#C74C4D"/><stop offset=".6" style="stop-color:#C21975"/><stop offset="1" style="stop-color:#7024C4"/></linearGradient><path id="XMLID_17_" style="fill:url(#XMLID_2_)" d="M386.878.0H164.156C73.64.0.0 73.64.0 164.156v222.722c0 90.516 73.64 164.156 164.156 164.156h222.722c90.516.0 164.156-73.64 164.156-164.156V164.156C551.033 73.64 477.393.0 386.878.0zM495.6 386.878c0 60.045-48.677 108.722-108.722 108.722H164.156c-60.045.0-108.722-48.677-108.722-108.722V164.156c0-60.046 48.677-108.722 108.722-108.722h222.722c60.045.0 108.722 48.676 108.722 108.722V386.878z"/><linearGradient id="XMLID_3_" gradientUnits="userSpaceOnUse" x1="275.517" y1="4.5714" x2="275.517" y2="549.7202" gradientTransform="matrix(1 0 0 -1 0 554)"><stop offset="0" style="stop-color:#E09B3D"/><stop offset=".3" style="stop-color:#C74C4D"/><stop offset=".6" style="stop-color:#C21975"/><stop offset="1" style="stop-color:#7024C4"/></linearGradient><path id="XMLID_81_" style="fill:url(#XMLID_3_)" d="M275.517 133C196.933 133 133 196.933 133 275.516s63.933 142.517 142.517 142.517S418.034 354.1 418.034 275.516 354.101 133 275.517 133zm0 229.6c-48.095.0-87.083-38.988-87.083-87.083s38.989-87.083 87.083-87.083c48.095.0 87.083 38.988 87.083 87.083C362.6 323.611 323.611 362.6 275.517 362.6z"/><linearGradient id="XMLID_4_" gradientUnits="userSpaceOnUse" x1="418.306" y1="4.5714" x2="418.306" y2="549.7202" gradientTransform="matrix(1 0 0 -1 0 554)"><stop offset="0" style="stop-color:#E09B3D"/><stop offset=".3" style="stop-color:#C74C4D"/><stop offset=".6" style="stop-color:#C21975"/><stop offset="1" style="stop-color:#7024C4"/></linearGradient><circle id="XMLID_83_" style="fill:url(#XMLID_4_)" cx="418.306" cy="134.072" r="34.149"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a></li><li><a href=https://www.linkedin.com/in/austin-barnes-03869218a/ target=_blank title=linkedin rel=me><svg id="Layer_1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 382 382" style="enable-background:new 0 0 382 382"><path style="fill:#0077b7" d="M347.445.0H34.555C15.471.0.0 15.471.0 34.555v312.889C0 366.529 15.471 382 34.555 382h312.889C366.529 382 382 366.529 382 347.444V34.555C382 15.471 366.529.0 347.445.0zM118.207 329.844c0 5.554-4.502 10.056-10.056 10.056H65.345c-5.554.0-10.056-4.502-10.056-10.056V150.403c0-5.554 4.502-10.056 10.056-10.056h42.806c5.554.0 10.056 4.502 10.056 10.056V329.844zM86.748 123.432c-22.459.0-40.666-18.207-40.666-40.666S64.289 42.1 86.748 42.1s40.666 18.207 40.666 40.666-18.206 40.666-40.666 40.666zM341.91 330.654c0 5.106-4.14 9.246-9.246 9.246H286.73c-5.106.0-9.246-4.14-9.246-9.246v-84.168c0-12.556 3.683-55.021-32.813-55.021-28.309.0-34.051 29.066-35.204 42.11v97.079c0 5.106-4.139 9.246-9.246 9.246h-44.426c-5.106.0-9.246-4.14-9.246-9.246V149.593c0-5.106 4.14-9.246 9.246-9.246h44.426c5.106.0 9.246 4.14 9.246 9.246v15.655c10.497-15.753 26.097-27.912 59.312-27.912 73.552.0 73.131 68.716 73.131 106.472L341.91 330.654z"/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://cinderblock.github.io/ selected>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#terraform-process>Terraform process</a></li><li><a href=#terraform-file-structure>Terraform File Structure</a><ol><li><a href=#providertf-file><em>provider.tf</em> File</a></li><li><a href=#networkingtf-file><em>networking.tf</em> File</a></li><li><a href=#variablestf-terraformtfvars-files><em>variables.tf, terraform.tfvars</em> Files</a></li><li><a href=#01-linuxclienttf--02-winserverstf-files><em>01-LinuxClient.tf</em> & <em>02-WinServers.tf</em> Files</a></li><li><a href=#outputstf-file>outputs.tf File</a></li></ol></li><li><a href=#cloud-init>Cloud-init</a></li><li><a href=#useful-azure-related-functions>Useful Azure related functions</a></li></ol><ol><li><a href=#ansible-variable-files>Ansible Variable files</a></li><li><a href=#running-ansible>Running Ansible</a></li></ol><ol><li><a href=#terraform-resources>Terraform Resources</a></li><li><a href=#ansible-resources>Ansible Resources</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/terraform-azure-server-deploy/><img src=/p/terraform-azure-server-deploy/Azure&amp;Terraform_hu_9117418b6a8399ef.png srcset="/p/terraform-azure-server-deploy/Azure&amp;Terraform_hu_9117418b6a8399ef.png 800w, /p/terraform-azure-server-deploy/Azure&amp;Terraform_hu_a4fa2d2c6a784e2f.png 1600w" width=800 height=450 loading=lazy alt="Featured image of post Terraform - Azure Server Deploy"></a></div><div class=article-details><header class=article-category><a href=/categories/terraform/ style=background-color:#2a9d8f;color:#fff>Terraform
</a><a href=/categories/windows-server/>Windows-Server
</a><a href=/categories/azure/ style=background-color:#2a9d8f;color:#fff>Azure
</a><a href=/categories/packer/ style=background-color:#2a9d8f;color:#fff>Packer
</a><a href=/categories/ansible/ style=background-color:#2a9d8f;color:#fff>Ansible</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/terraform-azure-server-deploy/>Terraform - Azure Server Deploy</a></h2><h3 class=article-subtitle>Terraform Automation in Azure with Windows Server. Creating an entire domain with DHCP, Filesharing, Active Dircetory, and more.</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 28, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>14 minute read</time></div></footer></div></header><section class=article-content><h1 id=overview>Overview</h1><p>Deploy and Configure 4 Windows 2022 Datacenter Servers in Azure.</p><ul><li>Using Terraform in conjunction with Ansible and cloudinit: Create 4 Windows Servers<ul><li>Configure them to be a Primary Domain Controller, Replica Domain Controller, DHCP server, and Fileshare server</li><li>Automate intial setup of the 4 servers to accept Ansible configuration from a Linux VM in Azure created VIA the Terraform deployment</li></ul></li></ul><p><strong>Check out all of the configuration files on <a class=link href=https://github.com/Cinderblook/tacklebox/tree/main/Terraform/Azure/Azure-Serv-Deploy target=_blank rel=noopener>GitHub (Azure-Serv-Deploy)</a> at the repository!</strong></p><h1 id=terraform>Terraform</h1><p>Main role: Deploy the Virtual Machines, setup Network environment, and provide intial parameters for both Windows and Linux environments running in the cloud</p><ul><li>Setup the four Windows Servers (Primary Domain Controller, Replica Domain Controller, DHCP, Fileshare) in Azure<ul><li>These will all be Windows 2022 Datacenter Servers running on Standard_DS1_V2 by default</li></ul></li><li>Setup the one Linux server to deploy a pre-defined Ansible configuration across the Windows Environment for setting up Active Directory, DHCP, File shares, users, and groups.<ul><li>This will all be an Ubuntu 18.04-LTS server running on Standard_B1s by default</li><li>It will use cloud-init to supply it the necessary setup at creation for Ansible and SSH connection VIA its public IP address.</li></ul></li><li>Supply necessary networking variables (Network interfaces, Security Groups, IP Addressing)</li><li>Supply necessary files for automation of Windows & Linux environments (Cloud-Init & Windows Unattend files)</li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li>Setup necessary Terraform <a class=link href=https://learn.hashicorp.com/tutorials/terraform/install-cli target=_blank rel=noopener>environment</a></li><li>Install and setup <a class=link href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli target=_blank rel=noopener>Azure CLI</a> or preferred method of authentication to Azure</li><li>Configure variables for desired outcomes (Outlined further down)</li></ul><h2 id=terraform-process>Terraform process</h2><ul><li>Using the Azure provider:<ul><li>Login to Azure with <code>az connect</code></li></ul></li><li>Once prepared with appropriate values and the networking is in place:<ul><li>Navigate to the Terraform directory and run these commands</li><li><code>terraform init</code> Pull proper Terraform providers and modules used</li><li><code>terraform validate</code> This will return whether the configuration is valid or not</li><li><code>terraform apply</code> &mldr; <code>yes</code> Actually apply the configuration</li></ul></li></ul><h2 id=terraform-file-structure>Terraform File Structure</h2><p>Create a new directory, and place the following files in it, with your own variables</p><h3 id=providertf-file><em>provider.tf</em> File</h3><ul><li>Calls necessary providers and sets their versions to be used in the Terraform configuration/deployment. Informs Terraform which modules and providers to use.</li></ul><p>provider.tf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>required_providers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>azurerm</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>source</span>  <span class=o>=</span> <span class=s2>&#34;hashicorp/azurerm&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span> <span class=o>=</span> <span class=s2>&#34;&gt;=2.91.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;azurerm&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>features</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=networkingtf-file><em>networking.tf</em> File</h3><ul><li>Defines resources, security groups, security rules, network interfaces, subnets, and public IPs to be created in Azure.<ul><li>These variables are pulled from the VM creation resources</li><li>Managed with variables contained in terraform.tfvars file</li></ul></li></ul><p>networking.tf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=c1># Create a resource group to maintain security settings along with network interfaces for VMs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_resource_group&#34;</span> <span class=s2>&#34;east&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>     <span class=o>=</span> <span class=s2>&#34;terra-resources&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span> <span class=o>=</span> <span class=s2>&#34;East US&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># ASSIGN ADDRESS SPACE TO RESOURCE GROUP
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_virtual_network&#34;</span> <span class=s2>&#34;east&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=s2>&#34;east-network&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>address_space</span>       <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>east_address_spaces</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># ASSIGN SUBNET TO NETWORK ADDRESS SPACE
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_subnet&#34;</span> <span class=s2>&#34;subnet1&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                 <span class=o>=</span> <span class=s2>&#34;internal&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span>  <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>virtual_network_name</span> <span class=o>=</span> <span class=nx>azurerm_virtual_network</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>address_prefixes</span>     <span class=o>=</span> <span class=p>[</span><span class=nb>var</span><span class=p>.</span><span class=nx>east_subnets</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Create public IP variable for Linux machine
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_public_ip&#34;</span> <span class=s2>&#34;linux_public&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=s2>&#34;PublicIp1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>allocation_method</span>   <span class=o>=</span> <span class=s2>&#34;Static&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Create public IP variable for Windows machine
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_public_ip&#34;</span> <span class=s2>&#34;win_public&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=s2>&#34;PublicIp2&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>allocation_method</span>   <span class=o>=</span> <span class=s2>&#34;Static&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># ASSIGN NETWORK INTERFACE PER VM WE WILL BE USING
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_interface&#34;</span> <span class=s2>&#34;linux1&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=s2>&#34;linux1-nic&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ip_configuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>                          <span class=o>=</span> <span class=s2>&#34;internal&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>subnet_id</span>                     <span class=o>=</span> <span class=nx>azurerm_subnet</span><span class=p>.</span><span class=nx>subnet1</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_ip_address_allocation</span> <span class=o>=</span> <span class=s2>&#34;Static&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_ip_address</span>            <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>linux1_priavte_ip</span>    
</span></span><span class=line><span class=cl>    <span class=nx>public_ip_address_id</span>          <span class=o>=</span> <span class=nx>azurerm_public_ip</span><span class=p>.</span><span class=nx>linux_public</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_interface&#34;</span> <span class=s2>&#34;winserv1&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=s2>&#34;winserv1-nic&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ip_configuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>                          <span class=o>=</span> <span class=s2>&#34;internal&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>subnet_id</span>                     <span class=o>=</span> <span class=nx>azurerm_subnet</span><span class=p>.</span><span class=nx>subnet1</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_ip_address_allocation</span> <span class=o>=</span> <span class=s2>&#34;Static&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_ip_address</span>            <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv1_private_ip</span>
</span></span><span class=line><span class=cl>    <span class=nx>public_ip_address_id</span>          <span class=o>=</span> <span class=nx>azurerm_public_ip</span><span class=p>.</span><span class=nx>win_public</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_interface&#34;</span> <span class=s2>&#34;winserv2&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=s2>&#34;winserv2-nic&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ip_configuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>                          <span class=o>=</span> <span class=s2>&#34;internal&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>subnet_id</span>                     <span class=o>=</span> <span class=nx>azurerm_subnet</span><span class=p>.</span><span class=nx>subnet1</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_ip_address_allocation</span> <span class=o>=</span> <span class=s2>&#34;Static&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_ip_address</span>            <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv2_private_ip</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_interface&#34;</span> <span class=s2>&#34;winserv3&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=s2>&#34;winserv3-nic&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ip_configuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>                          <span class=o>=</span> <span class=s2>&#34;internal&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>subnet_id</span>                     <span class=o>=</span> <span class=nx>azurerm_subnet</span><span class=p>.</span><span class=nx>subnet1</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_ip_address_allocation</span> <span class=o>=</span> <span class=s2>&#34;Static&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_ip_address</span>            <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv3_private_ip</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_interface&#34;</span> <span class=s2>&#34;winserv4&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=s2>&#34;winserv4-nic&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ip_configuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>                          <span class=o>=</span> <span class=s2>&#34;internal&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>subnet_id</span>                     <span class=o>=</span> <span class=nx>azurerm_subnet</span><span class=p>.</span><span class=nx>subnet1</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_ip_address_allocation</span> <span class=o>=</span> <span class=s2>&#34;Static&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_ip_address</span>            <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv4_private_ip</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># CREATE SECURITY GROUPs TO ALLOW SSH/RDP/ANSIBLE FOR VMs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_security_group&#34;</span> <span class=s2>&#34;linux1&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=s2>&#34;Allow-SSH&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>security_rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>                       <span class=o>=</span> <span class=s2>&#34;SSH&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>priority</span>                   <span class=o>=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl>    <span class=nx>direction</span>                  <span class=o>=</span> <span class=s2>&#34;Inbound&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>access</span>                     <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>protocol</span>                   <span class=o>=</span> <span class=s2>&#34;Tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>source_port_range</span>          <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>destination_port_range</span>     <span class=o>=</span> <span class=s2>&#34;22&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>source_address_prefix</span>      <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>destination_address_prefix</span> <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_security_group&#34;</span> <span class=s2>&#34;winserv&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=s2>&#34;Allow-RDP-SSH-ANS&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>security_rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>                       <span class=o>=</span> <span class=s2>&#34;RDP&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>priority</span>                   <span class=o>=</span> <span class=m>101</span>
</span></span><span class=line><span class=cl>    <span class=nx>direction</span>                  <span class=o>=</span> <span class=s2>&#34;Inbound&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>access</span>                     <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>protocol</span>                   <span class=o>=</span> <span class=s2>&#34;Tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>source_port_range</span>          <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>destination_port_range</span>     <span class=o>=</span> <span class=s2>&#34;3389&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>source_address_prefix</span>      <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>destination_address_prefix</span> <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>security_rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>                       <span class=o>=</span> <span class=s2>&#34;SSH&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>priority</span>                   <span class=o>=</span> <span class=m>102</span>
</span></span><span class=line><span class=cl>    <span class=nx>direction</span>                  <span class=o>=</span> <span class=s2>&#34;Inbound&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>access</span>                     <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>protocol</span>                   <span class=o>=</span> <span class=s2>&#34;Tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>source_port_range</span>          <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>destination_port_range</span>     <span class=o>=</span> <span class=s2>&#34;22&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>source_address_prefix</span>      <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>destination_address_prefix</span> <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>security_rule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>                       <span class=o>=</span> <span class=s2>&#34;ANSIBLE&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>priority</span>                   <span class=o>=</span> <span class=m>103</span>
</span></span><span class=line><span class=cl>    <span class=nx>direction</span>                  <span class=o>=</span> <span class=s2>&#34;Inbound&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>access</span>                     <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>protocol</span>                   <span class=o>=</span> <span class=s2>&#34;Tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>source_port_range</span>          <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>destination_port_range</span>     <span class=o>=</span> <span class=s2>&#34;5985&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>source_address_prefix</span>      <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>east_subnets</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>destination_address_prefix</span> <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># ASSIGN SECURITY GROUPS TO INTERFACES
</span></span></span><span class=line><span class=cl><span class=c1># LINUX SSH
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_interface_security_group_association&#34;</span> <span class=s2>&#34;linux1&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_interface_id</span>      <span class=o>=</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>linux1</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_security_group_id</span> <span class=o>=</span> <span class=nx>azurerm_network_security_group</span><span class=p>.</span><span class=nx>linux1</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># WINSERV RDP
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_interface_security_group_association&#34;</span> <span class=s2>&#34;winserv1&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_interface_id</span>      <span class=o>=</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv1</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_security_group_id</span> <span class=o>=</span> <span class=nx>azurerm_network_security_group</span><span class=p>.</span><span class=nx>winserv</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_interface_security_group_association&#34;</span> <span class=s2>&#34;winserv2&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_interface_id</span>      <span class=o>=</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv2</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_security_group_id</span> <span class=o>=</span> <span class=nx>azurerm_network_security_group</span><span class=p>.</span><span class=nx>winserv</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_interface_security_group_association&#34;</span> <span class=s2>&#34;winserv3&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_interface_id</span>      <span class=o>=</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv3</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_security_group_id</span> <span class=o>=</span> <span class=nx>azurerm_network_security_group</span><span class=p>.</span><span class=nx>winserv</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_network_interface_security_group_association&#34;</span> <span class=s2>&#34;winserv4&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_interface_id</span>      <span class=o>=</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv4</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_security_group_id</span> <span class=o>=</span> <span class=nx>azurerm_network_security_group</span><span class=p>.</span><span class=nx>winserv</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=variablestf-terraformtfvars-files><em>variables.tf, terraform.tfvars</em> Files</h3><ul><li>Alter variables within these files to ensure they meet your environment needs<ul><li><em>variables.tf</em><ul><li>Declare variables that will be used with the Terraform configuration (Delcared intially or explicitely here as <code>locals</code> variables)</li><li>Specific local variables used for Windows .xml files<ul><li><em>firsT_logon_commands</em> local variable points to a .xml file to configure first time logon in Windows. This enables each server to recieve Winrm data on port 5985 for Ansible configuration</li><li>*auto_logon_ runs a .xml configuration to log in once right after intial creation of VM. This allows <em>first_logon_commands</em> to execute automatically</li></ul></li></ul></li></ul></li></ul><p>variables.tf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_vm_os_publisher&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_vm_os_offer&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_vm_os_sku&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_vm_size&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winadmin_username&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winadmin_password&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_license&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_sa_type&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_pdc&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_rdc&#34;</span> <span class=p>{}</span> 
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_dhcp&#34;</span> <span class=p>{}</span> 
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_file&#34;</span> <span class=p>{}</span>    
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;linux_server&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;linux_vm_os_publisher&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;linux_vm_os_offer&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;linux_vm_os_sku&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;linux_vm_size&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;linux_ssh_key&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;linux_sa_type&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;linux_ssh_key_pv&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_allocation_method&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;east_address_spaces&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;east_subnets&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv_public_ip_sku&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv1_private_ip&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv2_private_ip&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv3_private_ip&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;winserv4_private_ip&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>variable</span> <span class=s2>&#34;linux1_priavte_ip&#34;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>locals</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>first_logon_commands</span>        <span class=o>=</span> <span class=nb>file</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>${</span><span class=nx>path</span><span class=p>.</span><span class=nb>module</span><span class=si>}</span><span class=s2>/          winfiles/FirstLogonCommands.xml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>auto_logon</span>                  <span class=o>=</span>           <span class=s2>&#34;&lt;AutoLogon&gt;&lt;Password&gt;&lt;Value&gt;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_password</span><span class=si>}</span><span class=s2>&lt;/          Value&gt;&lt;/Password&gt;&lt;Enabled&gt;true&lt;/Enabled&gt;&lt;LogonCount&gt;1&lt;/          LogonCount&gt;&lt;Username&gt;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_username</span><span class=si>}</span><span class=s2>&lt;/          Username&gt;&lt;/AutoLogon&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><em>terraform.tfvars</em><ul><li>Assign variables values here. These will be used with the Terraform configuration. If left blank, you can assign the variable at the terminal level when running the <code>terraform apply</code><ul><li>Alter Network values to desired IP addressing scheme<ul><li><strong>Ensure IP addressing matches that in the Ansible configuration inventory.yml</strong></li></ul></li><li>Here you can alter azure values for <em>publisher</em>, <em>offer</em>, <em>sku</em>, <em>size</em>, <em>sa</em>, and <em>license</em> information for the Windows/Linux VMs</li><li>Additionally, ensure <code>linux_ssh_key</code> point to your public Key <code>id_rsa.pubc</code> file</li><li>I recommend to change <em>winadmin_username</em> & <em>winadmin_password</em> variables to sensetive and blank so you can delcare them in preferrably Vaulty or via the CLI<ul><li><strong><em>winadmin_username</em> & <em>winadmin_password</em> MUST MATCH WHAT IS IN ANSIBLE /group_vars/all.yml</strong></li></ul></li></ul></li></ul></li></ul><p>terraform.tfvars</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=c1># Azure Windows Server related params
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>winserv_vm_os_publisher</span>     <span class=o>=</span><span class=s2>&#34;MicrosoftWindowsServer&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv_vm_os_offer</span>         <span class=o>=</span> <span class=s2>&#34;WindowsServer&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv_vm_os_sku</span>           <span class=o>=</span> <span class=s2>&#34;2022-Datacenter&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv_vm_size</span>             <span class=o>=</span> <span class=s2>&#34;Standard_DS1_V2&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv_license</span>             <span class=o>=</span> <span class=s2>&#34;Windows_Server&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv_allocation_method</span>   <span class=o>=</span> <span class=s2>&#34;Static&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv_public_ip_sku</span>       <span class=o>=</span> <span class=s2>&#34;Standard&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv_sa_type</span>             <span class=o>=</span> <span class=s2>&#34;Standard_LRS&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Azure Linux Server related params
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>linux_vm_os_publisher</span> <span class=o>=</span> <span class=s2>&#34;Canonical&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>linux_vm_os_offer</span>     <span class=o>=</span> <span class=s2>&#34;UbuntuServer&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>linux_vm_os_sku</span>       <span class=o>=</span> <span class=s2>&#34;18.04-LTS&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>linux_vm_size</span>         <span class=o>=</span> <span class=s2>&#34;Standard_B1s&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>linux_ssh_key</span>         <span class=o>=</span><span class=s2>&#34;Local-PUBLIC-SSH-KEY-Here&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>linux_sa_type</span>         <span class=o>=</span> <span class=s2>&#34;Premium_LRS&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>linux_ssh_key_pv</span>      <span class=o>=</span> <span class=s2>&#34;Local-PRIV-SSH-KEY-Here&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Which Windows administrator password to setduring vm           customization
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>winadmin_username</span> <span class=o>=</span> <span class=s2>&#34;SuperAdministrator&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winadmin_password</span> <span class=o>=</span> <span class=s2>&#34;Password1234&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Naming Schemes 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>winserv_pdc</span>    <span class=o>=</span> <span class=s2>&#34;ajb-pdc&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv_rdc</span>    <span class=o>=</span> <span class=s2>&#34;ajb-rdc&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv_dhcp</span>   <span class=o>=</span> <span class=s2>&#34;ajb-dhcp&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv_file</span>   <span class=o>=</span> <span class=s2>&#34;ajb-file&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>linux_server</span>   <span class=o>=</span> <span class=s2>&#34;ajb-operator&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Networking Variables
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>winserv1_private_ip</span>   <span class=o>=</span> <span class=s2>&#34;10.0.1.10&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv2_private_ip</span>   <span class=o>=</span> <span class=s2>&#34;10.0.1.11&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv3_private_ip</span>   <span class=o>=</span> <span class=s2>&#34;10.0.1.12&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>winserv4_private_ip</span>   <span class=o>=</span> <span class=s2>&#34;10.0.1.13&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>linux1_priavte_ip</span>     <span class=o>=</span> <span class=s2>&#34;10.0.1.9&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>east_address_spaces</span>  <span class=o>=</span> <span class=s2>&#34;10.0.0.0/16&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>east_subnets</span>         <span class=o>=</span> <span class=s2>&#34;10.0.1.0/24&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=01-linuxclienttf--02-winserverstf-files><em>01-LinuxClient.tf</em> & <em>02-WinServers.tf</em> Files</h3><ul><li>Here the creation of the VMs occur. Resources pull data from <em>networking.tf</em>, <em>variables.tf</em>, <em>terraform.tfvars</em> files.<ul><li>Windows VMs are assigned unattend configurations for first time setup (/winfiles/FirstLogonCommands.xml && <em>auto_logon</em> variable data)</li><li>Linux Machine is assigned a cloud-init file configuraiton for first time setup (/cloudinit/custom.yml) We will create this in the next step.</li></ul></li></ul><p>01-LinuxClient.tf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=c1># This pulls a Ubuntu Datacenter from Microsoft&#39;s VM platform directly
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_linux_virtual_machine&#34;</span> <span class=s2>&#34;operator&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>linux_server</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>size</span>                <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>linux_vm_size</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin_username</span>      <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_username</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_interface_ids</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>linux1</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>admin_ssh_key</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span>   <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_username</span>
</span></span><span class=line><span class=cl>    <span class=nx>public_key</span> <span class=o>=</span> <span class=nb>file</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>linux_ssh_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Cloud-Init passed here
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>custom_data</span> <span class=o>=</span> <span class=nb>data</span><span class=p>.</span><span class=nx>template_cloudinit_config</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>rendered</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>os_disk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>caching</span>              <span class=o>=</span> <span class=s2>&#34;ReadWrite&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage_account_type</span> <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>linux_sa_type</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>source_image_reference</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>publisher</span> <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>linux_vm_os_publisher</span>
</span></span><span class=line><span class=cl>    <span class=nx>offer</span>     <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>linux_vm_os_offer</span>
</span></span><span class=line><span class=cl>    <span class=nx>sku</span>       <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>linux_vm_os_sku</span>
</span></span><span class=line><span class=cl>    <span class=nx>version</span>   <span class=o>=</span> <span class=s2>&#34;latest&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>,</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>linux1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Create cloud-init file to be passed into linux vm
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>data</span> <span class=s2>&#34;template_file&#34;</span> <span class=s2>&#34;user_data&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>template</span> <span class=o>=</span> <span class=nb>file</span><span class=p>(</span><span class=s2>&#34;./cloudinit/custom.yml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1> 
</span></span></span><span class=line><span class=cl><span class=c1># Render a multi-part cloud-init config making use of the part
</span></span></span><span class=line><span class=cl><span class=c1># above, and other source files
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>data</span> <span class=s2>&#34;template_cloudinit_config&#34;</span> <span class=s2>&#34;config&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>gzip</span>          <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>base64_encode</span> <span class=o>=</span> <span class=kc>true</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Main cloud-config configuration file.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>part</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>filename</span>     <span class=o>=</span> <span class=s2>&#34;init.cfg&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>content_type</span> <span class=o>=</span> <span class=s2>&#34;text/cloud-config&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span>      <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nb>data</span><span class=p>.</span><span class=nx>template_file</span><span class=p>.</span><span class=nx>user_data</span><span class=p>.</span><span class=nx>rendered</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Pass Ansible File into created Linux VM using SCP (SSH Port 22)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;null_resource&#34;</span> <span class=s2>&#34;copyansible&#34;</span><span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=nx>connection</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span>        <span class=o>=</span> <span class=s2>&#34;ssh&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>host</span>        <span class=o>=</span> <span class=nx>azurerm_public_ip</span><span class=p>.</span><span class=nx>linux_public</span><span class=p>.</span><span class=nx>ip_address</span>
</span></span><span class=line><span class=cl>    <span class=nx>user</span>        <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_username</span>
</span></span><span class=line><span class=cl>    <span class=nx>private_key</span> <span class=o>=</span> <span class=nb>file</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>${</span><span class=nb>var</span><span class=p>.</span><span class=nx>linux_ssh_key_pv</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>provisioner</span> <span class=s2>&#34;file&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>source</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nx>path</span><span class=p>.</span><span class=nb>module</span><span class=si>}</span><span class=s2>/Ansible&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>destination</span> <span class=o>=</span> <span class=s2>&#34;/tmp/&#34;</span> 
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=nx>azurerm_linux_virtual_machine</span><span class=p>.</span><span class=nx>operator</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>02-WinServers.tf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=c1># This pulls the latest Windows Server Datacenter from Microsoft&#39;s VM platform directly
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;azurerm_windows_virtual_machine&#34;</span> <span class=s2>&#34;pdc&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_pdc</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>size</span>                <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_size</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin_username</span>      <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_username</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin_password</span>      <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_password</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_interface_ids</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv1</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>os_disk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>caching</span>              <span class=o>=</span> <span class=s2>&#34;ReadWrite&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage_account_type</span> <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_sa_type</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>source_image_reference</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>publisher</span> <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_publisher</span>
</span></span><span class=line><span class=cl>    <span class=nx>offer</span>     <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_offer</span>
</span></span><span class=line><span class=cl>    <span class=nx>sku</span>       <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_sku</span>
</span></span><span class=line><span class=cl>    <span class=nx>version</span>   <span class=o>=</span> <span class=s2>&#34;latest&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>additional_unattend_content</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span> <span class=o>=</span> <span class=nx>local</span><span class=p>.</span><span class=nx>auto_logon</span>
</span></span><span class=line><span class=cl>    <span class=nx>setting</span> <span class=o>=</span> <span class=s2>&#34;AutoLogon&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>additional_unattend_content</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span> <span class=o>=</span> <span class=nx>local</span><span class=p>.</span><span class=nx>first_logon_commands</span>
</span></span><span class=line><span class=cl>    <span class=nx>setting</span> <span class=o>=</span> <span class=s2>&#34;FirstLogonCommands&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>,</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_windows_virtual_machine&#34;</span> <span class=s2>&#34;rdc&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_rdc</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>size</span>                <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_size</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin_username</span>      <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_username</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin_password</span>      <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_password</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_interface_ids</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv2</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>os_disk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>caching</span>              <span class=o>=</span> <span class=s2>&#34;ReadWrite&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage_account_type</span> <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_sa_type</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>source_image_reference</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>publisher</span> <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_publisher</span>
</span></span><span class=line><span class=cl>    <span class=nx>offer</span>     <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_offer</span>
</span></span><span class=line><span class=cl>    <span class=nx>sku</span>       <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_sku</span>
</span></span><span class=line><span class=cl>    <span class=nx>version</span>   <span class=o>=</span> <span class=s2>&#34;latest&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>additional_unattend_content</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span> <span class=o>=</span> <span class=nx>local</span><span class=p>.</span><span class=nx>auto_logon</span>
</span></span><span class=line><span class=cl>    <span class=nx>setting</span> <span class=o>=</span> <span class=s2>&#34;AutoLogon&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>additional_unattend_content</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span> <span class=o>=</span> <span class=nx>local</span><span class=p>.</span><span class=nx>first_logon_commands</span>
</span></span><span class=line><span class=cl>    <span class=nx>setting</span> <span class=o>=</span> <span class=s2>&#34;FirstLogonCommands&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>,</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_windows_virtual_machine&#34;</span> <span class=s2>&#34;dhcp&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_dhcp</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>size</span>                <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_size</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin_username</span>      <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_username</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin_password</span>      <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_password</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_interface_ids</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv3</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>os_disk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>caching</span>              <span class=o>=</span> <span class=s2>&#34;ReadWrite&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage_account_type</span> <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_sa_type</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>source_image_reference</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>publisher</span> <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_publisher</span>
</span></span><span class=line><span class=cl>    <span class=nx>offer</span>     <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_offer</span>
</span></span><span class=line><span class=cl>    <span class=nx>sku</span>       <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_sku</span>
</span></span><span class=line><span class=cl>    <span class=nx>version</span>   <span class=o>=</span> <span class=s2>&#34;latest&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>additional_unattend_content</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span> <span class=o>=</span> <span class=nx>local</span><span class=p>.</span><span class=nx>auto_logon</span>
</span></span><span class=line><span class=cl>    <span class=nx>setting</span> <span class=o>=</span> <span class=s2>&#34;AutoLogon&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>additional_unattend_content</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span> <span class=o>=</span> <span class=nx>local</span><span class=p>.</span><span class=nx>first_logon_commands</span>
</span></span><span class=line><span class=cl>    <span class=nx>setting</span> <span class=o>=</span> <span class=s2>&#34;FirstLogonCommands&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>,</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;azurerm_windows_virtual_machine&#34;</span> <span class=s2>&#34;file&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_file</span>
</span></span><span class=line><span class=cl>  <span class=nx>resource_group_name</span> <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=nx>location</span>            <span class=o>=</span> <span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>.</span><span class=nx>location</span>
</span></span><span class=line><span class=cl>  <span class=nx>size</span>                <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_size</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin_username</span>      <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_username</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin_password</span>      <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winadmin_password</span>
</span></span><span class=line><span class=cl>  <span class=nx>network_interface_ids</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv4</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>os_disk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>caching</span>              <span class=o>=</span> <span class=s2>&#34;ReadWrite&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage_account_type</span> <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_sa_type</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>source_image_reference</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>publisher</span> <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_publisher</span>
</span></span><span class=line><span class=cl>    <span class=nx>offer</span>     <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_offer</span>
</span></span><span class=line><span class=cl>    <span class=nx>sku</span>       <span class=o>=</span> <span class=nb>var</span><span class=p>.</span><span class=nx>winserv_vm_os_sku</span>
</span></span><span class=line><span class=cl>    <span class=nx>version</span>   <span class=o>=</span> <span class=s2>&#34;latest&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>additional_unattend_content</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span> <span class=o>=</span> <span class=nx>local</span><span class=p>.</span><span class=nx>auto_logon</span>
</span></span><span class=line><span class=cl>    <span class=nx>setting</span> <span class=o>=</span> <span class=s2>&#34;AutoLogon&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>additional_unattend_content</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span> <span class=o>=</span> <span class=nx>local</span><span class=p>.</span><span class=nx>first_logon_commands</span>
</span></span><span class=line><span class=cl>    <span class=nx>setting</span> <span class=o>=</span> <span class=s2>&#34;FirstLogonCommands&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=nx>azurerm_resource_group</span><span class=p>.</span><span class=nx>east</span><span class=p>,</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>winserv4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=outputstf-file>outputs.tf File</h3><ul><li>Provides necessary ip information that is allocated to the VMs created.</li><li>This information by default includes:<ul><li>Private IPs for all 5 deployed VMs (Which we know will by based on variables.tf file data)</li><li>Public IP for Linux machine (Not known by default, will be used for SSH connection if needed).</li></ul></li></ul><p>outputs.tf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;Public_IP_Linux&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>value</span> <span class=o>=</span> <span class=nx>azurerm_public_ip</span><span class=p>.</span><span class=nx>linux_public</span><span class=p>.</span><span class=nx>ip_address</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;Public_IP_Windows&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>value</span> <span class=o>=</span> <span class=nx>azurerm_public_ip</span><span class=p>.</span><span class=nx>win_public</span><span class=p>.</span><span class=nx>ip_address</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;Private_IP_Linux&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>value</span> <span class=o>=</span> <span class=nx>azurerm_network_interface</span><span class=p>.</span><span class=nx>linux1</span><span class=p>.</span><span class=nx>private_ip_address</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>output</span> <span class=s2>&#34;Private_IP_WinServ&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>value</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;PDC: </span><span class=si>${</span><span class=nx>azurerm_windows_virtual_machine</span><span class=p>.</span><span class=nx>pdc</span><span class=p>.</span><span class=nx>private_ip_address</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;RDC: </span><span class=si>${</span><span class=nx>azurerm_windows_virtual_machine</span><span class=p>.</span><span class=nx>rdc</span><span class=p>.</span><span class=nx>private_ip_address</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;DHCP: </span><span class=si>${</span><span class=nx>azurerm_windows_virtual_machine</span><span class=p>.</span><span class=nx>dhcp</span><span class=p>.</span><span class=nx>private_ip_address</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;FILE: </span><span class=si>${</span><span class=nx>azurerm_windows_virtual_machine</span><span class=p>.</span><span class=nb>file</span><span class=p>.</span><span class=nx>private_ip_address</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=cloud-init>Cloud-init</h2><p>Notice that in the 01-linux file, there is a cloud-init section, where the spun up machine will pull a cloud-init file. We must create that. Make a a folder inside your root terraform directory. Name it cloudinit. Inside that folder, create a file called <code>custom.yml</code> containing the following.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c>#cloud-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apt_update</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>packages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>python-pip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>runcmd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>sudo pip install ansible</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>sudo ansible-galaxy install azure.azure_preview_modules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>sudo pip install -r ~/.ansible/roles/azure.azure_preview_modules/files/requirements-azure.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pip install &#34;pywinrm&gt;=0.2.2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>cd /tmp/Ansible</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>sudo ansible-playbook winlab.yml</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=useful-azure-related-functions>Useful Azure related functions</h2><p>Finding variable information for VM Images variables:</p><ul><li>You can use this command in Azure CLI to find UbuntuServer data. Change the values in offer, publisher, location, and sku for various other images.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Powershell data-lang=Powershell><span class=line><span class=cl>   <span class=n>az</span> <span class=n>vm</span> <span class=n>image</span> <span class=n>list</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>   <span class=p>-</span><span class=n>-location</span> <span class=n>westus</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>   <span class=p>-</span><span class=n>-publisher</span> <span class=n>Canonical</span> <span class=p>\</span>  
</span></span><span class=line><span class=cl>   <span class=p>-</span><span class=n>-offer</span> <span class=n>UbuntuServer</span> <span class=p>\</span>    
</span></span><span class=line><span class=cl>   <span class=p>-</span><span class=n>-sku</span> <span class=mf>18.04</span><span class=n>-LTS</span> <span class=p>\</span>
</span></span><span class=line><span class=cl>   <span class=p>-</span><span class=n>-all</span> <span class=p>-</span><span class=n>-output</span> <span class=n>table</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>&ldquo;Check out Microsoft&rsquo;s&rdquo; <a class=link href=https://docs.microsoft.com/en-us/azure/virtual-machines/linux/cli-ps-findimage target=_blank rel=noopener>documentation</a> on finding VM information</li></ul><h1 id=ansible>Ansible</h1><p>Main role: Configure the deployed Virtual Machines.</p><p>Check out the repository on <a class=link href=https://github.com/Cinderblook/Azure-Serv-Deploy target=_blank rel=noopener>GitHub</a> for the configuration files!</p><ul><li>Setup Windows Server Feature: Domain<ul><li>Primary Domain Controller</li><li>Replica Domain Controller</li><li>Auto-Join the Virutal Machines to the respective Domain created</li><li>Create a few users and groups within Active Directory</li></ul></li><li>Setup Windows Ssrver Feature: DHCP<ul><li>Setup DHCP Scope</li><li>Authorize it to the Domain.</li></ul></li><li>Setup Windows Server Feature: File Sharing<ul><li>Create two shares<ul><li>An employee share and administrator share. These shares are assigned group permissions.</li></ul></li></ul></li><li>Common Configurations<ul><li>Enable RDP and allow it through the firewall on all windows servers created at server level</li></ul></li></ul><h2 id=ansible-variable-files>Ansible Variable files</h2><ul><li><em>inventory.yml</em><ul><li>Modify hosts associated with the playbook. Assign the IP addressing<ul><li><strong>MUST MATCH <em>terraform.tfvars</em> VARIABLE IP ADDRESSING</strong></li></ul></li></ul></li><li><em>winlab.yml</em><ul><li>Associate &lsquo;roles&rsquo; to the hosts identified in the inventory file.</li><li>These &lsquo;roles&rsquo; are folders within the directory containing a set of code to configure per host</li></ul></li><li><em>ansible.cfg</em><ul><li>Tells ansible variable information. In this scenario, identifies to use inventory.yml file.</li></ul></li><li><em>./group_vars/all.yml</em><ul><li>Contains specific variable information used within the ./roles/* Ansible code.</li><li>Alter user, password, port, connection, and cert variable information</li><li>Alter domain variables as well</li></ul></li></ul><h2 id=running-ansible>Running Ansible</h2><p>This is taken care of with terraform cloud-init file along with the file provisioner. The alternative would be below.</p><ul><li>On Linux Machine,<ul><li>Requires: Python-pip, ansible-galaxzy-azure.azure_preview_modules</li><li>To Run: Navigate to Ansible directory and type <code>ansible-playbook winlab.yml</code></li></ul></li></ul><h1 id=useful-resources>Useful Resources</h1><h2 id=terraform-resources>Terraform Resources</h2><ul><li>Terraform <a class=link href=https://www.terraform.io/docs target=_blank rel=noopener>Documentation</a></li><li>Azure <a class=link href=https://registry.terraform.io/providers/hashicorp/azurerm/2.96.0 target=_blank rel=noopener>Provider</a> & <a class=link href=https://registry.terraform.io/modules/Azure/compute/azurerm/latest target=_blank rel=noopener>Modules</a></li><li>Cloud-init <a class=link href=https://cloudinit.readthedocs.io/en/latest/ target=_blank rel=noopener>Documentation</a></li><li><a class=link href=https://github.com/hashicorp/terraform-provider-azurerm target=_blank rel=noopener>terraform-provider-azurerm</a> examples and documentation on GitHub</li></ul><h2 id=ansible-resources>Ansible Resources</h2><ul><li>Ansible <a class=link href=https://docs.ansible.com/ target=_blank rel=noopener>Documentation</a><ul><li><a class=link href="https://galaxy.ansible.com/ansible/windows?extIdCarryOver=true&amp;sc_cid=701f2000001OH7YAAW" target=_blank rel=noopener>Windows-Modules</a></li></ul></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/terraform/>Terraform</a>
<a href=/tags/ansible/>Ansible</a>
<a href=/tags/automation/>Automation</a>
<a href=/tags/azure/>Azure</a>
<a href=/tags/windows-server/>Windows-Server</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/terraform-vsphere-windows-server-deployment/><div class=article-image><img src=/p/terraform-vsphere-windows-server-deployment/vSphereBanner.18e33d6be6e8342164955290e845a398_hu_558fe97fb954a825.png width=250 height=150 loading=lazy alt="Featured image of post Terraform - vSphere Windows Server Deployment" data-hash="md5-GOM9a+boNCFklVKQ6EWjmA=="></div><div class=article-details><h2 class=article-title>Terraform - vSphere Windows Server Deployment</h2></div></a></article><article class=has-image><a href=/p/terrifying-or-converting-azure-resources-into-terraform-code/><div class=article-image><img src=/p/terrifying-or-converting-azure-resources-into-terraform-code/AzureTerrify.46c36dd56028f46810e468b1f1c88936_hu_32e8f3131549ffd8.png width=250 height=150 loading=lazy alt="Featured image of post 'Terrifying' or Converting Azure Resources into Terraform Code" data-hash="md5-RsNt1WAo9GgQ5Gix8ciJNg=="></div><div class=article-details><h2 class=article-title>'Terrifying' or Converting Azure Resources into Terraform Code</h2></div></a></article><article class=has-image><a href=/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/><div class=article-image><img src=/p/terraform-azure-kubernetes-with-helm-charts-and-cloudflare/AzureK8SHelm.c85f8101a63cfee3b672f010dfca2a69_hu_22b38a19968a9481.png width=250 height=150 loading=lazy alt="Featured image of post Terraform - Azure Kubernetes with Helm Charts and Cloudflare" data-hash="md5-yF+BAaY8/uO2cvAQ38oqaQ=="></div><div class=article-details><h2 class=article-title>Terraform - Azure Kubernetes with Helm Charts and Cloudflare</h2></div></a></article><article class=has-image><a href=/p/terraform-azure-kubernetes-deployment/><div class=article-image><img src=/p/terraform-azure-kubernetes-deployment/Terraform-DeployingKubernetesAKS.ae4fc22927c0a8923c43889d3de011c1_hu_f0fe79aecc009347.png width=250 height=150 loading=lazy alt="Featured image of post Terraform - Azure Kubernetes Deployment" data-hash="md5-rk/CKSfAqJI8Q4idPeARwQ=="></div><div class=article-details><h2 class=article-title>Terraform - Azure Kubernetes Deployment</h2></div></a></article><article class=has-image><a href=/p/ansible-semaphore-automating-updates/><div class=article-image><img src=/p/ansible-semaphore-automating-updates/Ansible-Semaphore.32ae807d310bc47a46a9996da4ce81f7_hu_c86fffe7aeecfc94.png width=250 height=150 loading=lazy alt="Featured image of post Ansible Semaphore - Automating Updates" data-hash="md5-Mq6AfTELxHpGqZltpM6B9w=="></div><div class=article-details><h2 class=article-title>Ansible Semaphore - Automating Updates</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2021 -
2025 Cinderblock</section><section class=powerby>Enthusiastic guy who enjoys the outdoors, flying drones, homelabbing, and of course, all things tech!<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>